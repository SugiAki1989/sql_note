## :memo: Overview

対数の性質を使って、累積和から累積積を計算する。

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`ln`

## :pencil2: Example

末尾の参照 URL にある通りカプランマイヤーカーブを SQL で計算しようとすると、計算の過程上、累積積を計算する必要が出てくる。ただ、SQL には累積積を直接計算する方法はないので、対数の性質を利用する。

対数の和は対数の積として表せるので、対数をとって累積和を計算し、指数を取ることでもとのスケールに戻せば、累積積を計算することができる。マイナスや 0 は計算できないので注意。

```sql
select
	empno,
	sal/100 as sal,
	floor(exp(sum(ln(sal/100)) over(order by sal, empno))) as runprod
from
	emp
;

 empno | sal |        runprod
-------+-----+-----------------------
  7369 |   8 |                     7
  7900 |   9 |                    72
  7876 |  11 |                   792
  7521 |  12 |                  9504
  7654 |  12 |                114048
  7934 |  13 |               1482623
  7844 |  15 |              22239359
  7499 |  16 |             355829759
  7782 |  24 |            8539914239
  7698 |  28 |          239117598719
  7566 |  29 |         6934410362879
  7788 |  30 |       208032310886399
  7902 |  30 | 6.240969326591992e+15
  7839 |  50 | 3.120484663295997e+17
```

たしかに累積積はこの方法で計算できるものの、ウインドウ関数の`order by`の指定を誤ると、誤った累積積が計算される。例えば下記の通り、`7521`と`7654`の`sal`はかぶっているため、`order by`でここの並び替えまで指定していないと、重複終了後の値が格納されることになる。

```sql
select
	empno,
	sal/100 as sal,
	sum(sal/100) over(order by sal) as runsum_dup,
    floor(exp(sum(ln(sal/100)) over(order by sal))) as runprod_dup,
	sum(sal/100) over(order by sal, empno) as runsum,
    floor(exp(sum(ln(sal/100)) over(order by sal, empno))) as runprod
from
	emp
;

 empno | sal | runsum_dup |      runprod_dup      | runsum |        runprod
-------+-----+------------+-----------------------+--------+-----------------------
  7369 |   8 |          8 |                     7 |      8 |                     7
  7900 |   9 |         17 |                    72 |     17 |                    72
  7876 |  11 |         28 |                   792 |     28 |                   792
  7521 |  12 |         52 |                114048 |     40 |                  9504
  7654 |  12 |         52 |                114048 |     52 |                114048
  7934 |  13 |         65 |               1482623 |     65 |               1482623
  7844 |  15 |         80 |              22239359 |     80 |              22239359
  7499 |  16 |         96 |             355829759 |     96 |             355829759
  7782 |  24 |        120 |            8539914239 |    120 |            8539914239
  7698 |  28 |        148 |          239117598719 |    148 |          239117598719
  7566 |  29 |        177 |         6934410362879 |    177 |         6934410362879
  7788 |  30 |        237 | 6.240969326591992e+15 |    207 |       208032310886399
  7902 |  30 |        237 | 6.240969326591992e+15 |    237 | 6.240969326591992e+15
  7839 |  50 |        287 | 3.120484663295997e+17 |    287 | 3.120484663295997e+17
```

## :closed_book: Reference

- [How to compute Kaplan-Meier survival curves in SQL](https://www.crosstab.io/articles/sql-survival-curves)
