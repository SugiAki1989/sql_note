## :memo: Overview

月曜日に関する前処理と書いているが、他の曜日でも問題ない。ここで扱うのは、1 年間の全ての月曜日を求める方法や 1 月の最初と最後の月曜日の日付を求める方法をまとめている。

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`date_part('dow')`, `dayofweek`, `a`, `a`, `a`

## :pencil2: Example

PostgreSQL と MySQL では曜日を返す関数の返り値が異なるので注意が必要。

|  -  | PostgreSQL: date_part('dow') | MySQL: dayofweek |
| :-: | :--------------------------: | :--------------: |
|  0  |            日曜日            |       None       |
|  1  |            月曜日            |      日曜日      |
|  2  |            火曜日            |      月曜日      |
|  3  |            水曜日            |      火曜日      |
|  4  |            木曜日            |      水曜日      |
|  5  |            金曜日            |      木曜日      |
|  6  |            土曜日            |      金曜日      |
|  7  |             None             |      土曜日      |

このことを前提に、1 年間の全ての月曜日の一覧を求める。`date_part('dow')`が返す値の`1=月曜日`に限定すれば、年間のすべての月曜日を取得できる。

```sql
with tmp as (
    select createdat, round((random() * (1 - 100))::numeric, 0) + 100 as value
    from generate_series('2022-01-01 00:00:00'::timestamp with time zone,
					     '2022-12-31 00:00:00'::timestamp with time zone,
					     '1 day') as createdat
)
select
    createdat,
    date_part('dow', createdat) as dow
from
    tmp
where
    date_part('dow', createdat) = 1
;

       createdat        | dow
------------------------+-----
 2022-01-03 00:00:00+09 |   1
 2022-01-10 00:00:00+09 |   1
 2022-01-17 00:00:00+09 |   1
 2022-01-24 00:00:00+09 |   1
 2022-01-31 00:00:00+09 |   1
 2022-02-07 00:00:00+09 |   1
 略
 2022-12-19 00:00:00+09 |   1
 2022-12-26 00:00:00+09 |   1

```

これを発展させて、特定の年月の最初と最後の月曜日を求める。方針としては、まずは曜日の間隔は 7 日間。7 日間が繰り返されるという規則を利用する。2022 年 7 月であれば、最初の月曜日は 4 日で、最後の月曜日は 25 日となる。2022 年 7 月 4 月さえわかれば、次は 11 日、次は 18 日、最後は 25 日と連鎖して求めることができるという方法もあるが、年月でグループ化して、最初と最後を取れば同じことが実現できる。

```sql
with tmp as (
    select createdat, round((random() * (1 - 100))::numeric, 0) + 100 as value
    from generate_series('2022-01-01 00:00:00'::timestamp with time zone,
					     '2022-12-31 00:00:00'::timestamp with time zone,
					     '1 day') as createdat
), tmp2 as (
select
    createdat,
    date_part('dow', createdat) as dow,
    date_trunc('month', createdat) as ym
from
    tmp
where
    date_part('dow', createdat) = 1
)
select
    ym,
    min(createdat) as first_monday,
    max(createdat) as last_monday
from
    tmp2
group by
    ym
;

           ym           |      first_monday      |      last_monday
------------------------+------------------------+------------------------
 2022-01-01 00:00:00+09 | 2022-01-03 00:00:00+09 | 2022-01-31 00:00:00+09
 2022-02-01 00:00:00+09 | 2022-02-07 00:00:00+09 | 2022-02-28 00:00:00+09
 2022-03-01 00:00:00+09 | 2022-03-07 00:00:00+09 | 2022-03-28 00:00:00+09
 2022-04-01 00:00:00+09 | 2022-04-04 00:00:00+09 | 2022-04-25 00:00:00+09
 2022-05-01 00:00:00+09 | 2022-05-02 00:00:00+09 | 2022-05-30 00:00:00+09
 2022-06-01 00:00:00+09 | 2022-06-06 00:00:00+09 | 2022-06-27 00:00:00+09
 2022-07-01 00:00:00+09 | 2022-07-04 00:00:00+09 | 2022-07-25 00:00:00+09
 2022-08-01 00:00:00+09 | 2022-08-01 00:00:00+09 | 2022-08-29 00:00:00+09
 2022-09-01 00:00:00+09 | 2022-09-05 00:00:00+09 | 2022-09-26 00:00:00+09
 2022-10-01 00:00:00+09 | 2022-10-03 00:00:00+09 | 2022-10-31 00:00:00+09
 2022-11-01 00:00:00+09 | 2022-11-07 00:00:00+09 | 2022-11-28 00:00:00+09
 2022-12-01 00:00:00+09 | 2022-12-05 00:00:00+09 | 2022-12-26 00:00:00+09
```

さらに面倒な依頼として、特定の年月の 3 回目の月曜日の日付をとってほしいと言うことになれば、下記のように番号をふって対応することで処理できる。

```sql
with tmp as (
    select createdat, round((random() * (1 - 100))::numeric, 0) + 100 as value
    from generate_series('2022-01-01 00:00:00'::timestamp with time zone,
					     '2022-12-31 00:00:00'::timestamp with time zone,
					     '1 day') as createdat
), tmp2 as (
select
    createdat,
    date_part('dow', createdat) as dow,
    date_trunc('month', createdat) as ym
from
    tmp
where
    date_part('dow', createdat) = 1
), tmp3 as (
select
    createdat,
    dow,
    ym,
    row_number() over(partition by ym order by ym asc) as downum
from
    tmp2
)
select
    ym,
    createdat,
    dow,
    downum
from
    tmp3
where
    downum = 3
;

           ym           |       createdat        | dow | downum
------------------------+------------------------+-----+--------
 2022-01-01 00:00:00+09 | 2022-01-17 00:00:00+09 |   1 |      3
 2022-02-01 00:00:00+09 | 2022-02-21 00:00:00+09 |   1 |      3
 2022-03-01 00:00:00+09 | 2022-03-21 00:00:00+09 |   1 |      3
 2022-04-01 00:00:00+09 | 2022-04-18 00:00:00+09 |   1 |      3
 2022-05-01 00:00:00+09 | 2022-05-16 00:00:00+09 |   1 |      3
 2022-06-01 00:00:00+09 | 2022-06-20 00:00:00+09 |   1 |      3
 2022-07-01 00:00:00+09 | 2022-07-18 00:00:00+09 |   1 |      3
 2022-08-01 00:00:00+09 | 2022-08-15 00:00:00+09 |   1 |      3
 2022-09-01 00:00:00+09 | 2022-09-19 00:00:00+09 |   1 |      3
 2022-10-01 00:00:00+09 | 2022-10-17 00:00:00+09 |   1 |      3
 2022-11-01 00:00:00+09 | 2022-11-21 00:00:00+09 |   1 |      3
 2022-12-01 00:00:00+09 | 2022-12-19 00:00:00+09 |   1 |      3
(12 rows)
```

特定の年月日から 1 つ前の月曜日と 1 つ先の月曜日を計算する方法をまとめておく。

例えば、`2022-09-04`日曜日の 1 つ前の月曜日は `2022-08-29` であり、1 つ先の月曜日は `2022-09-05` である。また、`2022-09-05`月曜日の 1 つ前の月曜日は `2022-08-29` であり、1 つ先の月曜日は `2022-09-12`である。

`date_part('dow')`は`0`を日曜日として数字を返すので、これを使って、月曜日を基準とするならば、月曜日が `7` になるように調整して、日付から引け足しすれば前後の月曜日の日付が得られる。

```sql
with tmp as (
    select createdat::date,
    case date_part('dow', createdat)
    when 0 then '日'
    when 1 then '月'
    when 2 then '火'
    when 3 then '水'
    when 4 then '木'
    when 5 then '金'
    when 6 then '土'
    end as y,
    date_part('dow', createdat) as dow
    from generate_series('2022-08-15 00:00:00'::timestamp with time zone,
					     '2022-09-30 00:00:00'::timestamp with time zone,
					     '1 day') as createdat
), tmp2 as (
select
    createdat, y, dow,
    -- 前の月曜日
    case when date_part('dow', createdat)-1 <= 0 then 7 - abs(date_part('dow', createdat)-1)
    else date_part('dow', createdat)-1 end as previous,
    -- 次の月曜日
    case when dow = 0 then 1
    else  8 - dow end as next
from
    tmp
)
select
    createdat, y, dow,
    previous,
    createdat - cast(previous as integer) as previousmonday,
    next,
    createdat + cast(next as integer) as nextmonday
from
    tmp2
;

 createdat  | y  | dow | previous | previousmonday | next | nextmonday
------------+----+-----+----------+----------------+------+------------
 2022-08-15 | 月 |   1 |        7 | 2022-08-08     |    7 | 2022-08-22
 2022-08-16 | 火 |   2 |        1 | 2022-08-15     |    6 | 2022-08-22
 2022-08-17 | 水 |   3 |        2 | 2022-08-15     |    5 | 2022-08-22
 2022-08-18 | 木 |   4 |        3 | 2022-08-15     |    4 | 2022-08-22
 2022-08-19 | 金 |   5 |        4 | 2022-08-15     |    3 | 2022-08-22
 2022-08-20 | 土 |   6 |        5 | 2022-08-15     |    2 | 2022-08-22
 2022-08-21 | 日 |   0 |        6 | 2022-08-15     |    1 | 2022-08-22
 2022-08-22 | 月 |   1 |        7 | 2022-08-15     |    7 | 2022-08-29
 2022-08-23 | 火 |   2 |        1 | 2022-08-22     |    6 | 2022-08-29
 2022-08-24 | 水 |   3 |        2 | 2022-08-22     |    5 | 2022-08-29
 2022-08-25 | 木 |   4 |        3 | 2022-08-22     |    4 | 2022-08-29
 2022-08-26 | 金 |   5 |        4 | 2022-08-22     |    3 | 2022-08-29
 2022-08-27 | 土 |   6 |        5 | 2022-08-22     |    2 | 2022-08-29
 2022-08-28 | 日 |   0 |        6 | 2022-08-22     |    1 | 2022-08-29
 2022-08-29 | 月 |   1 |        7 | 2022-08-22     |    7 | 2022-09-05
 2022-08-30 | 火 |   2 |        1 | 2022-08-29     |    6 | 2022-09-05
 2022-08-31 | 水 |   3 |        2 | 2022-08-29     |    5 | 2022-09-05
 2022-09-01 | 木 |   4 |        3 | 2022-08-29     |    4 | 2022-09-05
 2022-09-02 | 金 |   5 |        4 | 2022-08-29     |    3 | 2022-09-05
 2022-09-03 | 土 |   6 |        5 | 2022-08-29     |    2 | 2022-09-05
 2022-09-04 | 日 |   0 |        6 | 2022-08-29     |    1 | 2022-09-05
 2022-09-05 | 月 |   1 |        7 | 2022-08-29     |    7 | 2022-09-12
 2022-09-06 | 火 |   2 |        1 | 2022-09-05     |    6 | 2022-09-12
 2022-09-07 | 水 |   3 |        2 | 2022-09-05     |    5 | 2022-09-12
 2022-09-08 | 木 |   4 |        3 | 2022-09-05     |    4 | 2022-09-12
 2022-09-09 | 金 |   5 |        4 | 2022-09-05     |    3 | 2022-09-12
 2022-09-10 | 土 |   6 |        5 | 2022-09-05     |    2 | 2022-09-12
 2022-09-11 | 日 |   0 |        6 | 2022-09-05     |    1 | 2022-09-12
 2022-09-12 | 月 |   1 |        7 | 2022-09-05     |    7 | 2022-09-19
 2022-09-13 | 火 |   2 |        1 | 2022-09-12     |    6 | 2022-09-19
 2022-09-14 | 水 |   3 |        2 | 2022-09-12     |    5 | 2022-09-19
 2022-09-15 | 木 |   4 |        3 | 2022-09-12     |    4 | 2022-09-19
 2022-09-16 | 金 |   5 |        4 | 2022-09-12     |    3 | 2022-09-19
 2022-09-17 | 土 |   6 |        5 | 2022-09-12     |    2 | 2022-09-19
 2022-09-18 | 日 |   0 |        6 | 2022-09-12     |    1 | 2022-09-19
 2022-09-19 | 月 |   1 |        7 | 2022-09-12     |    7 | 2022-09-26
 2022-09-20 | 火 |   2 |        1 | 2022-09-19     |    6 | 2022-09-26
 2022-09-21 | 水 |   3 |        2 | 2022-09-19     |    5 | 2022-09-26
 2022-09-22 | 木 |   4 |        3 | 2022-09-19     |    4 | 2022-09-26
 2022-09-23 | 金 |   5 |        4 | 2022-09-19     |    3 | 2022-09-26
 2022-09-24 | 土 |   6 |        5 | 2022-09-19     |    2 | 2022-09-26
 2022-09-25 | 日 |   0 |        6 | 2022-09-19     |    1 | 2022-09-26
 2022-09-26 | 月 |   1 |        7 | 2022-09-19     |    7 | 2022-10-03
 2022-09-27 | 火 |   2 |        1 | 2022-09-26     |    6 | 2022-10-03
 2022-09-28 | 水 |   3 |        2 | 2022-09-26     |    5 | 2022-10-03
 2022-09-29 | 木 |   4 |        3 | 2022-09-26     |    4 | 2022-10-03
 2022-09-30 | 金 |   5 |        4 | 2022-09-26     |    3 | 2022-10-03
(47 rows)

```

## :closed_book: Reference

None
