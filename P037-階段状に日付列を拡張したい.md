## :memo: Overview

階段状に日付を拡張するというのは、`2022-08-15, 2022-08-16`という 1 行があった場合に、1 行目はそのまま`2022-08-15, 2022-08-16`、2 行目は`2022-08-15, 2022-08-16, 2022-08-17`、3 行目は`2022-08-15, 2022-08-16, 2022-08-17, 2022-08-18`という形で、行が進むたびに、1 日分の列が増えるデータの加工方法のこと。下記のようなイメージ。

```sql
 id |     s      |     e      | gs |     e1     |     e2
----+------------+------------+----+------------+------------
  1 | 2022-08-15 | 2022-08-16 |  1 |            |
  1 | 2022-08-15 | 2022-08-16 |  2 | 2022-08-17 |
  1 | 2022-08-15 | 2022-08-16 |  3 | 2022-08-18 | 2022-08-18
```

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`generate_series`, `a`, `a`

## :pencil2: Example

サンプルデータを用意する。

```sql
create table stairs(id integer, s date, e date);
insert into
    stairs(id, s, e)
values
    ('1','2022-08-15','2022-08-16'),
    ('2','2022-08-17','2022-08-18'),
    ('3','2022-08-19','2022-08-20'),
    ('4','2022-08-21','2022-08-22'),
    ('5','2022-08-23','2022-08-24')
;
```

基本的な方針としては、`cross join`で直積を作り、階段の段数分のデータを作成する。その階段は`generate_series`の連番で何階かを示す数字がついているので、判定しながら階段を作成すれば終わり。

```sql
with tmp as(
select
    id,
    s,
    e,
    gs
from
    stairs
cross join
    generate_series(1, 3) as gs
)
select
    id,
    s,
    e,
    gs,
    case when gs >= 2 then e + gs-1 else null end as e1,
    case when gs >= 3 then e + gs-1 else null end as e2
from
    tmp
order by
    id, gs
;

 id |     s      |     e      | gs |     e1     |     e2
----+------------+------------+----+------------+------------
  1 | 2022-08-15 | 2022-08-16 |  1 |            |
  1 | 2022-08-15 | 2022-08-16 |  2 | 2022-08-17 |
  1 | 2022-08-15 | 2022-08-16 |  3 | 2022-08-18 | 2022-08-18
  2 | 2022-08-17 | 2022-08-18 |  1 |            |
  2 | 2022-08-17 | 2022-08-18 |  2 | 2022-08-19 |
  2 | 2022-08-17 | 2022-08-18 |  3 | 2022-08-20 | 2022-08-20
  3 | 2022-08-19 | 2022-08-20 |  1 |            |
  3 | 2022-08-19 | 2022-08-20 |  2 | 2022-08-21 |
  3 | 2022-08-19 | 2022-08-20 |  3 | 2022-08-22 | 2022-08-22
  4 | 2022-08-21 | 2022-08-22 |  1 |            |
  4 | 2022-08-21 | 2022-08-22 |  2 | 2022-08-23 |
  4 | 2022-08-21 | 2022-08-22 |  3 | 2022-08-24 | 2022-08-24
  5 | 2022-08-23 | 2022-08-24 |  1 |            |
  5 | 2022-08-23 | 2022-08-24 |  2 | 2022-08-25 |
  5 | 2022-08-23 | 2022-08-24 |  3 | 2022-08-26 | 2022-08-26
```

## :closed_book: Reference

- [SQL Cookbook](https://www.oreilly.com/library/view/sql-cookbook/0596009763/)
- [SQL クックブック 第 2 版](https://www.oreilly.co.jp/books/9784873119779/)
