## :memo: Overview

アクセスログなどの 1 秒毎に値が生成されるデータは数秒単位でまとめて傾向を確認したい時がある。任意の秒単位で集計する方法をまとめておく。

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`generate_series`

## :pencil2: Example

1 秒毎に値が生成される疑似センサーデータを`generate_series`で作成する。ここでは 3 秒単位で値を集計したいので、3 秒ごとにグループ識別子を作成する必要があるので、`row_number`で連番を付与してから商を求めて、商の結果を丸めることでグループ識別子を作成する。このあたりの話は、下記で取り扱っている。

- [Page040-グループ識別子を作成する.md](https://github.com/SugiAki1989/sql_note/blob/main/P040-%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E8%AD%98%E5%88%A5%E5%AD%90%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B.md)

```sql
with tmp as (
select createdat, round((random() * (1 - 100))::numeric, 0) + 100 as value,
       row_number() over(order by createdat asc)::real as idx
from generate_series('2022-08-18 15:30:00'::timestamp with time zone,
					 '2022-08-18 16:30:00'::timestamp with time zone,
					 '1 seconds') as createdat
)
select
    idx,
    idx/3 as tmp,
    ceiling(idx/3) as tmpceiling,
    createdat,
    value
from
    tmp
limit 10
;

 idx |        tmp         | tmpceiling |       createdat        | value
-----+--------------------+------------+------------------------+-------
   1 | 0.3333333333333333 |          1 | 2022-08-18 15:30:00+09 |    81
   2 | 0.6666666666666666 |          1 | 2022-08-18 15:30:01+09 |    61
   3 |                  1 |          1 | 2022-08-18 15:30:02+09 |    80
   4 | 1.3333333333333333 |          2 | 2022-08-18 15:30:03+09 |     4
   5 | 1.6666666666666667 |          2 | 2022-08-18 15:30:04+09 |    56
   6 |                  2 |          2 | 2022-08-18 15:30:05+09 |    74
   7 | 2.3333333333333335 |          3 | 2022-08-18 15:30:06+09 |     7
   8 | 2.6666666666666665 |          3 | 2022-08-18 15:30:07+09 |    52
   9 |                  3 |          3 | 2022-08-18 15:30:08+09 |    89
  10 | 3.3333333333333335 |          4 | 2022-08-18 15:30:09+09 |     3
(10 rows)
```

後は集計をグループ識別子を利用して、集計すれば、自分の集計したい単位秒で集計ができる。

```sql
with tmp as (
select createdat, round((random() * (1 - 100))::numeric, 0) + 100 as value,
       row_number() over()::real as idx
from generate_series('2022-08-18 15:30:00'::timestamp with time zone,
					 '2022-08-18 16:30:00'::timestamp with time zone,
					 '1 seconds') as createdat
)
select
    ceiling(idx/3) as unit,
    min(createdat) as start,
    max(createdat) as end,
    round(avg(value),2) as avg
from
    tmp
group by
    ceiling(idx/3)
order by
    unit asc
limit 30
;
 unit |         start          |          end           |  avg
------+------------------------+------------------------+-------
    1 | 2022-08-18 15:30:00+09 | 2022-08-18 15:30:02+09 | 55.00
    2 | 2022-08-18 15:30:03+09 | 2022-08-18 15:30:05+09 | 32.67
    3 | 2022-08-18 15:30:06+09 | 2022-08-18 15:30:08+09 | 51.33
    4 | 2022-08-18 15:30:09+09 | 2022-08-18 15:30:11+09 | 18.67
    5 | 2022-08-18 15:30:12+09 | 2022-08-18 15:30:14+09 | 81.00
    6 | 2022-08-18 15:30:15+09 | 2022-08-18 15:30:17+09 | 82.33
    7 | 2022-08-18 15:30:18+09 | 2022-08-18 15:30:20+09 | 70.67
    8 | 2022-08-18 15:30:21+09 | 2022-08-18 15:30:23+09 | 65.67
    9 | 2022-08-18 15:30:24+09 | 2022-08-18 15:30:26+09 | 41.00
   10 | 2022-08-18 15:30:27+09 | 2022-08-18 15:30:29+09 | 54.33
   11 | 2022-08-18 15:30:30+09 | 2022-08-18 15:30:32+09 | 55.67
   12 | 2022-08-18 15:30:33+09 | 2022-08-18 15:30:35+09 | 76.00
   13 | 2022-08-18 15:30:36+09 | 2022-08-18 15:30:38+09 | 50.00
   14 | 2022-08-18 15:30:39+09 | 2022-08-18 15:30:41+09 | 41.33
   15 | 2022-08-18 15:30:42+09 | 2022-08-18 15:30:44+09 | 69.00
   16 | 2022-08-18 15:30:45+09 | 2022-08-18 15:30:47+09 | 51.33
   17 | 2022-08-18 15:30:48+09 | 2022-08-18 15:30:50+09 | 36.67
   18 | 2022-08-18 15:30:51+09 | 2022-08-18 15:30:53+09 | 84.33
   19 | 2022-08-18 15:30:54+09 | 2022-08-18 15:30:56+09 | 37.00
   20 | 2022-08-18 15:30:57+09 | 2022-08-18 15:30:59+09 | 44.00
   21 | 2022-08-18 15:31:00+09 | 2022-08-18 15:31:02+09 | 24.67
   22 | 2022-08-18 15:31:03+09 | 2022-08-18 15:31:05+09 | 59.00
   23 | 2022-08-18 15:31:06+09 | 2022-08-18 15:31:08+09 | 77.00
   24 | 2022-08-18 15:31:09+09 | 2022-08-18 15:31:11+09 | 59.00
   25 | 2022-08-18 15:31:12+09 | 2022-08-18 15:31:14+09 | 70.00
   26 | 2022-08-18 15:31:15+09 | 2022-08-18 15:31:17+09 | 68.33
   27 | 2022-08-18 15:31:18+09 | 2022-08-18 15:31:20+09 | 33.00
   28 | 2022-08-18 15:31:21+09 | 2022-08-18 15:31:23+09 | 58.67
   29 | 2022-08-18 15:31:24+09 | 2022-08-18 15:31:26+09 | 33.67
   30 | 2022-08-18 15:31:27+09 | 2022-08-18 15:31:29+09 | 79.00
(30 rows)
```

## :closed_book: Reference

None
