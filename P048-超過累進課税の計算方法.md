## :memo: Overview

超過累進課税の計算を SQL で行う場合の方法についてまとめておく。超過累進課税については下記が詳しい。

- [累進課税制度とは？税率計算や対象となる所得税等の税金について解説](https://biz.moneyforward.com/tax_return/basic/51628/)

累進課税制度は金額レンジに応じて、そのレンジに対応する税率が書けられている課税制度のこと。

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`a`, `a`, `a`

## :pencil2: Example

必要なサンプルデータを用意する。税率の下限上限が記録されているテーブルと、年収が記録されているテーブルがあるとする。税率の上限しか記録されているテーブルしかない場合、ルールに合わせて上限下限を作成しておく必要がある。

```sql
create table taxs(low int, high bigint, rate real);
insert into
    taxs(low, high, rate)
values
    ('0','1950000','0.05'),
    ('1950000','3300000','0.10'),
    ('3300000','6500000','0.20'),
    ('6500000','9000000','0.23'),
    ('9000000','18000000','0.33'),
    ('18000000','40000000','0.40'),
    ('18000000','9999999999','0.45')
    ;

create table taxsperson(id int, salary int);
insert into
    taxsperson(id, salary)
values
    ('1','1900000'),
    ('2','3000000'),
    ('3','5000000')
    ;
```

累進課税の計算は[累進課税制度とは？税率計算や対象となる所得税等の税金について解説](https://biz.moneyforward.com/tax_return/basic/51628/)のサイトの通り、下記のように SQL で計算すればよい。

> 1. 所得 300 万円の場合
>    　 195 万円 ×5％＋（300 万円－195 万円）×10％＝ 202,500 円（税額）
>
> 2. 所得 500 万円の場合
>    　 195 万円 ×5％ ＋（330 万円－195 万円）×10％＋（500 万円－330 万円）×20％＝ 572,500 円（税額）

例えば`id=3`は年収が 500 万円なので、適用される税率が`0.05`と`0.10`と`0.20`の 3 つがあるので、これを紐付けるために不等号結合を行う。加工するイメージがわかりやすいように可視化しておく。

```sql
195 × 5％
+（330 - 195 = 135）× 10％
+（500 - 330 = 170）× 20％
= 572500
```

この加工を行うためには、`taxsperson.salary > taxs.low`として、`salary`よりも小さい税率を紐付ければ良い。

```sql
select
    id,
    salary,
    low,
    high,
    rate
from
    taxsperson
inner join
    taxs
on
    taxsperson.salary > taxs.low
order by
    id,
    salary
;

 id | salary  |   low   |  high   | rate
----+---------+---------+---------+------
  1 | 1900000 |       0 | 1950000 | 0.05
  2 | 3000000 |       0 | 1950000 | 0.05
  2 | 3000000 | 1950000 | 3300000 |  0.1

  3 | 5000000 |       0 | 1950000 | 0.05
  3 | 5000000 | 1950000 | 3300000 |  0.1
  3 | 5000000 | 3300000 | 6500000 |  0.2
(6 rows)
```

次に、`high - low`をすれば税を適用する金額を算出できそうだが、こうすると少し問題が発生する。つまり、レンジ全体が適用範囲となる場合、問題が発生しないが、レンジの途中までしか給料がない場合、課題に課税していることになる。

```sql
select
    id,
    salary,
    low,
    high,
    high - low as highlow,
    rate
from
    taxsperson
inner join
    taxs
on
    taxsperson.salary > taxs.low
order by
    id,
    salary
;

 id | salary  |   low   |  high   | highlow | rate
----+---------+---------+---------+---------+------
  1 | 1900000 |       0 | 1950000 | 1950000 | 0.05 -- 本当は195万円ではなく、190万円
  2 | 3000000 |       0 | 1950000 | 1950000 | 0.05
  2 | 3000000 | 1950000 | 3300000 | 1350000 |  0.1 -- 本当は135万円ではなく、105万円
  3 | 5000000 |       0 | 1950000 | 1950000 | 0.05
  3 | 5000000 | 1950000 | 3300000 | 1350000 |  0.1
  3 | 5000000 | 3300000 | 6500000 | 3200000 |  0.2 -- 本当は320万円ではなく、170万円
(6 rows)
```

これを修正するために、`least`を使う。こうすることで、`0~1950000`のレンジでは 195 万円、`1950000~3300000`のレンジでは 135 万円、`3300000~6500000`のレンジでは 320 万円ではなく、170 万円を対象にできる。

```sql
select
    id,
    salary,
    low,
    high,
    high - low as highlow,
    salary - low as salarylow,
    least(salary - low, high - low) as tmpsal,
    rate
from
    taxsperson
inner join
    taxs
on
    taxsperson.salary > taxs.low
order by
    id,
    salary
;

 id | salary  |   low   |  high   | highlow | salarylow |  tmpsal | rate
----+---------+---------+---------+---------+-----------+---------+------
  1 | 1900000 |       0 | 1950000 | 1950000 |   1900000 | 1900000 | 0.05
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  2 | 3000000 |       0 | 1950000 | 1950000 |   3000000 | 1950000 | 0.05
  2 | 3000000 | 1950000 | 3300000 | 1350000 |   1050000 | 1050000 |  0.1
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  3 | 5000000 |       0 | 1950000 | 1950000 |   5000000 | 1950000 | 0.05
  3 | 5000000 | 1950000 | 3300000 | 1350000 |   3050000 | 1350000 |  0.1
  3 | 5000000 | 3300000 | 6500000 | 3200000 |   1700000 | 1700000 |  0.2
(6 rows)
```

後は給料と税率を使って集計すれば課税金額が算出できる。

```sql
select
    id,
    floor(
        sum(
            least(salary - low, high - low) * rate
            )
    ) as taxdue
from
    taxsperson
inner join
    taxs
on
    taxsperson.salary > taxs.low
group by
    id
order by
    id asc
;

 id | taxdue
----+--------
  1 |  95000
  2 | 202500
  3 | 572500
(3 rows)
```

## :closed_book: Reference

None
