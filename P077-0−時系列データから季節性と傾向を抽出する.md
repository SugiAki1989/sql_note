## :memo: Overview

SQL で時系列データを季節分解する方法をまとめておく。季節調整法はいろんな方法があるが、ここでは一番シンプルな簡単な季節調整法を実行する。基本的には、時系列データは下記の要素に分解できるとされている。これは加法的なモデルで、乗法的に考えるモデルもある。

- トレンド(Trend)：メトリックの基本的な傾向。
- 季節性(Seasonal)：一定期間繰り返されるパターンのこと。
- 不規則変動(Random)：ノイズのことで、季節およびトレンドが削除された後の元の時系列の残差。

$$
y = Trend + Seasonal + Random
$$

つまり、各要素がわかれば足したり引いたりすることで、分解できるので、各要素をいかにして計算するかがポイントになる。例えば、`Random = y - Trend - Seasonal`と計算すれば、ランダムな部分を計算できる。

ここでまとめている季節調整法は、中心化移動平均でトレンドを計算する。ここでは周期を 12 ヶ月周期としている。このトレンドをもとに、トレンドを除去したデータを作る。この系列から月ごとの平均を得ることで、平均的な季節周期の値が得られる(つまり、各月の平均的な値の年間分)。そして、もとの原系列からトレンド、季節周期を除けば、ランダムノイズが得られ分解完了となる。

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`decompose`, `moving average`

## :pencil2: Example

まずは飛行機の乗客数データをここでは利用する。R であれば`AirPassenger`として利用できるデータ。このデータは乗法的なので、加法分解ではなく乗法分解が適している可能性はある。

```sql
create table airpass(y numeric, time date);
\copy airpass from '/Users/aki/Desktop/airpassengers.csv' (encoding 'utf8', format csv, header true);
```

まずは中心化移動平均を計算する。カレント行に対して前が 5 で後 6 の合計 12 フレームで移動平均を計算する。

```sql
select
    time, y, extract(month from time) as m,
    case when
    count(*) over (order by time asc rows between 5 preceding and 6 following) = 12
    then avg(y) over (order by time asc rows between 5 preceding and 6 following)
    else null end as trend
from
    airpass
;

    time    |  y  | m  |        trend
------------+-----+----+----------------------
 1949-01-01 | 112 |  1 |
 1949-02-01 | 118 |  2 |
 1949-03-01 | 132 |  3 |
 1949-04-01 | 129 |  4 |
 1949-05-01 | 121 |  5 |
 1949-06-01 | 135 |  6 | 126.6666666666666667
 1949-07-01 | 148 |  7 | 126.9166666666666667
 1949-08-01 | 148 |  8 | 127.5833333333333333
(snip)
 1960-04-01 | 461 |  4 | 471.5833333333333333
 1960-05-01 | 472 |  5 | 473.9166666666666667
 1960-06-01 | 535 |  6 | 476.1666666666666667
 1960-07-01 | 622 |  7 |
 1960-08-01 | 606 |  8 |
 1960-09-01 | 508 |  9 |
 1960-10-01 | 461 | 10 |
 1960-11-01 | 390 | 11 |
 1960-12-01 | 432 | 12 |
(144 rows)
```

中心化移動平均は、このようなイメージ。

```sql
    time    |  y  |        trend
------------+-----+----------------------
 1949-01-01 | 112 |                      -- 1
 1949-02-01 | 118 |                      -- 2 -- 1
 1949-03-01 | 132 |                      -- 3 -- 2 -- 1
 1949-04-01 | 129 |                      -- 4 -- 3 -- 2
 1949-05-01 | 121 |                      -- 5 -- 4 -- 3
 1949-06-01 | 135 | 126.6666666666666667 -- ★ -- 5 -- 4
 1949-07-01 | 148 | 126.9166666666666667 -- 1 -- ★ -- 5
 1949-08-01 | 148 | 127.5833333333333333 -- 2 -- 1 -- ★
 1949-09-01 | 136 | 128.3333333333333333 -- 3 -- 2 -- 1
 1949-10-01 | 119 | 128.8333333333333333 -- 4 -- 3 -- 2
 1949-11-01 | 104 | 129.1666666666666667 -- 5 -- 4 -- 3
 1949-12-01 | 118 | 130.3333333333333333 -- 6 -- 5 -- 4
 1950-01-01 | 115 | 132.1666666666666667      -- 6 -- 5
 1950-02-01 | 126 | 134.0000000000000000           -- 6
 1950-03-01 | 141 | 135.8333333333333333
 1950-04-01 | 135 | 137.0000000000000000
 1950-05-01 | 125 | 137.8333333333333333
```

ここから`detrend`を月ごとに平均した`seasonal`を計算する。

```sql
with tmp as (
select
    time, y, extract(month from time) as m,
    case when
    count(*) over (order by time asc rows between 5 preceding and 6 following) = 12
    then avg(y) over (order by time asc rows between 5 preceding and 6 following)
    else null end as trend
from
    airpass
)
select
    time, y, m, trend,
    y - trend as detrend,
    avg(y - trend) over (partition by m) as seasonal
from
    tmp
order by
    time asc
;

    time    |  y  | m  |        trend         |       detrend        |       seasonal
------------+-----+----+----------------------+----------------------+----------------------
 1949-01-01 | 112 |  1 |                      |                      | -27.2954545454545455
 1949-02-01 | 118 |  2 |                      |                      | -38.6742424242424242
 1949-03-01 | 132 |  3 |                      |                      |  -4.4015151515151515
 1949-04-01 | 129 |  4 |                      |                      | -10.0833333333333333
 1949-05-01 | 121 |  5 |                      |                      |  -6.3409090909090909
 1949-06-01 | 135 |  6 | 126.6666666666666667 |   8.3333333333333333 |  31.3680555555555555
 1949-07-01 | 148 |  7 | 126.9166666666666667 |  21.0833333333333333 |  61.9242424242424242
 1949-08-01 | 148 |  8 | 127.5833333333333333 |  20.4166666666666667 |  61.0378787878787879
(snip)
 1960-03-01 | 419 |  3 | 467.0833333333333333 | -48.0833333333333333 |  -4.4015151515151515
 1960-04-01 | 461 |  4 | 471.5833333333333333 | -10.5833333333333333 | -10.0833333333333333
 1960-05-01 | 472 |  5 | 473.9166666666666667 |  -1.9166666666666667 |  -6.3409090909090909
 1960-06-01 | 535 |  6 | 476.1666666666666667 |  58.8333333333333333 |  31.3680555555555555
 1960-07-01 | 622 |  7 |                      |                      |  61.9242424242424242
 1960-08-01 | 606 |  8 |                      |                      |  61.0378787878787879
 1960-09-01 | 508 |  9 |                      |                      |  14.6818181818181818
 1960-10-01 | 461 | 10 |                      |                      | -22.6515151515151515
 1960-11-01 | 390 | 11 |                      |                      | -55.6742424242424242
 1960-12-01 | 432 | 12 |                      |                      | -30.8863636363636364
(144 rows)
```

そして、`y`から`trend`と`seasonal`を引けば、`random`を計算できるので、これで分解完了。

```sql
with tmp as (
select
    time, y, extract(month from time) as m,
    case when
    count(*) over (order by time asc rows between 5 preceding and 6 following) = 12
    then avg(y) over (order by time asc rows between 5 preceding and 6 following)
    else null end as trend
from
    airpass
), tmp2 as (
select
    time, y, m, trend,
    y - trend as detrend,
    avg(y - trend) over (partition by m) as seasonal
from
    tmp
order by
    time asc
)
select
    time, y, m, trend, detrend, seasonal,
    y - trend - seasonal as random
from
    tmp2
;

    time    |  y  | m  |        trend         |       detrend        |       seasonal       |        random
------------+-----+----+----------------------+----------------------+----------------------+----------------------
 1949-01-01 | 112 |  1 |                      |                      | -27.2954545454545455 |
 1949-02-01 | 118 |  2 |                      |                      | -38.6742424242424242 |
 1949-03-01 | 132 |  3 |                      |                      |  -4.4015151515151515 |
 1949-04-01 | 129 |  4 |                      |                      | -10.0833333333333333 |
 1949-05-01 | 121 |  5 |                      |                      |  -6.3409090909090909 |
 1949-06-01 | 135 |  6 | 126.6666666666666667 |   8.3333333333333333 |  31.3680555555555555 | -23.0347222222222222
 1949-07-01 | 148 |  7 | 126.9166666666666667 |  21.0833333333333333 |  61.9242424242424242 | -40.8409090909090909
 1949-08-01 | 148 |  8 | 127.5833333333333333 |  20.4166666666666667 |  61.0378787878787879 | -40.6212121212121212
(snip)
 1960-04-01 | 461 |  4 | 471.5833333333333333 | -10.5833333333333333 | -10.0833333333333333 |  -0.5000000000000000
 1960-05-01 | 472 |  5 | 473.9166666666666667 |  -1.9166666666666667 |  -6.3409090909090909 |   4.4242424242424242
 1960-06-01 | 535 |  6 | 476.1666666666666667 |  58.8333333333333333 |  31.3680555555555555 |  27.4652777777777778
 1960-07-01 | 622 |  7 |                      |                      |  61.9242424242424242 |
 1960-08-01 | 606 |  8 |                      |                      |  61.0378787878787879 |
 1960-09-01 | 508 |  9 |                      |                      |  14.6818181818181818 |
 1960-10-01 | 461 | 10 |                      |                      | -22.6515151515151515 |
 1960-11-01 | 390 | 11 |                      |                      | -55.6742424242424242 |
 1960-12-01 | 432 | 12 |                      |                      | -30.8863636363636364 |
(144 rows)
```

分解しているだけなので、もとに戻すことは勿論可能。

```sql
with tmp as (
select
    time, y, extract(month from time) as m,
    case when
    count(*) over (order by time asc rows between 5 preceding and 6 following) = 12
    then avg(y) over (order by time asc rows between 5 preceding and 6 following)
    else null end as trend
from
    airpass
), tmp2 as (
select
    time, y, m, trend,
    y - trend as detrend,
    avg(y - trend) over (partition by m) as seasonal
from
    tmp
order by
    time asc
), tmp3 as (
select
    time, y, m, trend, detrend, seasonal,
    y - trend - seasonal as random
from
    tmp2
)
select
    time, y,
    trend + seasonal + random as recompose,
    y - (trend + seasonal + random) as diff
from
    tmp3
;

    time    |  y  |      recompose       |        diff
------------+-----+----------------------+--------------------
 1949-01-01 | 112 |                      |
 1949-02-01 | 118 |                      |
 1949-03-01 | 132 |                      |
 1949-04-01 | 129 |                      |
 1949-05-01 | 121 |                      |
 1949-06-01 | 135 | 135.0000000000000000 | 0.0000000000000000
 1949-07-01 | 148 | 148.0000000000000000 | 0.0000000000000000
 1949-08-01 | 148 | 148.0000000000000000 | 0.0000000000000000
 (snip)
 1960-04-01 | 461 | 461.0000000000000000 | 0.0000000000000000
 1960-05-01 | 472 | 472.0000000000000000 | 0.0000000000000000
 1960-06-01 | 535 | 535.0000000000000000 | 0.0000000000000000
 1960-07-01 | 622 |                      |
 1960-08-01 | 606 |                      |
 1960-09-01 | 508 |                      |
 1960-10-01 | 461 |                      |
 1960-11-01 | 390 |                      |
 1960-12-01 | 432 |                      |
(144 rows)
```

## :closed_book: Reference

- [Extracting Seasonality and Trend from Data: Decomposition Using R](https://anomaly.io/seasonal-trend-decomposition-in-r/index.html)
- [How to Seasonally Adjust a Time Series in R](https://anomaly.io/seasonally-adjustement-in-r/index.html)
