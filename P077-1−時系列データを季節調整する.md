## :memo: Overview

SQL で時系列データを季節分解する方法をまとめておく。季節調整法はいろんな方法があるが、ここでは一番シンプルな簡単な季節調整を実行する。経産省のデータや資料を利用する。

- [特定サービス産業動態統計調査](https://www.meti.go.jp/statistics/tyo/tokusabido/result/result_1.html)
- [第４章 季節調整の考え方](https://www.meti.go.jp/statistics/tyo/iip/riyou-4.pdf)

季節調整を行なうことで、原系列から周期性(季節性)の繰り返す変動を除去することで、トレンドとランダムノイズに分解することで変動要因を調べることができる。つまり、下記から`Seasonal`を取り除いたデータを作成する。

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`decompose`, `moving average`

## :pencil2: Example

テーマパークの売上データをここでは利用する。

```sql
create table themepark(d date, y numeric);
\copy themepark from '/Users/aki/Desktop/ThemePark20.csv' (encoding 'utf8', format csv, header true);

select
    d,
    y
from
    themepark
;

     d      |   y
------------+-------
 2000-01-01 |  5222
 2000-02-01 |  5464
 2000-03-01 |  5430
 2000-04-01 |  5245
 2000-05-01 |  4887
 2000-06-01 |  5721
 2000-07-01 |  5016
 2000-08-01 |  4543
 2000-09-01 |  5583
 2000-10-01 |  5546
 2000-11-01 |  5881
 2000-12-01 |  6780
 2001-01-01 |  5629
 2001-02-01 |  5841
 2001-03-01 |  5697
 2001-04-01 |  5547
 2001-05-01 |  5069
 (snip)
 2022-07-01 |  9910
 2022-08-01 |  8722
 2022-09-01 | 10654
 2022-10-01 | 10681
(274 rows)
```

まずは 12 ヶ月移動平均を計算する。カレント行に対して後 11 の合計 12 フレームで移動平均を計算する。移動平均を計算する理由としては、トレンドとして利用するため。つまり、現系列をトレンドのみに変換するイメージ。

```sql
select
    d,
    y,
    extract(month from d) as m,
    case when
    count(*) over (order by d asc rows between 11 preceding and current row) = 12
    then avg(y) over (order by d asc rows between 11 preceding and current row)
    else null end as trend
from
    themepark
;

     d      |   y   | m  |         trend
------------+-------+----+------------------------
 2000-01-01 |  5222 |  1 |
 2000-02-01 |  5464 |  2 |
 2000-03-01 |  5430 |  3 |
 2000-04-01 |  5245 |  4 |
 2000-05-01 |  4887 |  5 |
 2000-06-01 |  5721 |  6 |
 2000-07-01 |  5016 |  7 |
 2000-08-01 |  4543 |  8 |
 2000-09-01 |  5583 |  9 |
 2000-10-01 |  5546 | 10 |
 2000-11-01 |  5881 | 11 |
 2000-12-01 |  6780 | 12 |  5443.1666666666666667
 2001-01-01 |  5629 |  1 |  5477.0833333333333333
 2001-02-01 |  5841 |  2 |  5508.5000000000000000
 2001-03-01 |  5697 |  3 |  5530.7500000000000000
 2001-04-01 |  5547 |  4 |  5555.9166666666666667
 2001-05-01 |  5069 |  5 |  5571.0833333333333333
```

次に、計算したトレンドを使って、現系列を割り戻す。これは現系列が乗法的であれば、トレンドで割ることで、現系列からトレンドを除去し、季節性とランダムな部分のみにするイメージ。これに当たるのが`sesonal_adj`で季節調整値に該当する。次は、`sesonal_adj`を月ごとに平均することで、`sesonal_adj_per_month`を作成する。これは、各月の季節調整値を平均することで、過去の傾向から 1 月はこれくらい、2 月はこれくらい、3 月はこれくらいは大きくなったり、小さくなったりする、というのを表現させる。`sesonal_adj`を平均することで、ランダムな部分を均して取り除き、季節性のみにするイメージ。外れ値を除外するためにトリム平均を使って、補正値を作る場合もあるが、ここではトリム平均は利用しない。

```sql
with tmp as (
select
    d,
    y,
    extract(month from d) as m,
    case when
    count(*) over (order by d asc rows between 11 preceding and current row) = 12
    then avg(y) over (order by d asc rows between 11 preceding and current row)
    else null end as trend
from
    themepark
)
select
    d,y,m,trend,
    y / trend as sesonal_adj,
    avg(y / trend) over (partition by m) as sesonal_adj_per_month,
    row_number () over (order by d asc) as rownum
from
    tmp
order by
    d asc
;

     d      |   y   | m  |         trend          |      sesonal_adj       | sesonal_adj_per_month  | rownum
------------+-------+----+------------------------+------------------------+------------------------+--------
 2000-01-01 |  5222 |  1 |                        |                        | 0.99578248929620220818 |      1
 2000-02-01 |  5464 |  2 |                        |                        | 1.07534593570604523640 |      2
 2000-03-01 |  5430 |  3 |                        |                        | 0.99886070889974613945 |      3
 2000-04-01 |  5245 |  4 |                        |                        | 0.97782366415812035248 |      4
 2000-05-01 |  4887 |  5 |                        |                        | 0.91794428723466620537 |      5
 2000-06-01 |  5721 |  6 |                        |                        | 1.02134144897621284102 |      6
 2000-07-01 |  5016 |  7 |                        |                        | 0.98597823758139566395 |      7
 2000-08-01 |  4543 |  8 |                        |                        | 0.83758903734782468589 |      8
 2000-09-01 |  5583 |  9 |                        |                        | 1.05473487592504440247 |      9
 2000-10-01 |  5546 | 10 |                        |                        | 1.07879719387760603364 |     10
 2000-11-01 |  5881 | 11 |                        |                        |     1.0901695389693435 |     11
 2000-12-01 |  6780 | 12 |  5443.1666666666666667 |     1.2455984567806730 |     1.1406744478662378 |     12
 2001-01-01 |  5629 |  1 |  5477.0833333333333333 |     1.0277367820464055 | 0.99578248929620220818 |     13
 2001-02-01 |  5841 |  2 |  5508.5000000000000000 |     1.0603612598711083 | 1.07534593570604523640 |     14
 2001-03-01 |  5697 |  3 |  5530.7500000000000000 |     1.0300592143922614 | 0.99886070889974613945 |     15
```

`sesonal_adj_per_month`は月ごとの平均的な増減率を表していたので、仮に季節がなんの影響を及ぼさないのであれば、12(1 が 12 回。四半期だったら 4 になる、週であれば 7)になるはず。現状では、12.175 となっており、少し大きいため、これを調整する必要がでてくる。足して 12 にしたいので、`12 / 12.175 = 0.985`を補正値として利用する。これは`12.175 * 0.985 = 12`であるため。

```sql
with tmp as (
select
    d,
    y,
    extract(month from d) as m,
    case when
    count(*) over (order by d asc rows between 11 preceding and current row) = 12
    then avg(y) over (order by d asc rows between 11 preceding and current row)
    else null end as trend
from
    themepark
), tmp2 as (
select
    d,y,m,trend,
    y / trend as sesonal_adj,
    avg(y / trend) over (partition by m) as sesonal_adj_per_month,
    row_number () over (order by d asc) as rownum
from
    tmp
order by
    d asc
)
select
    max(rownum) as max_rownum,
    sum(sesonal_adj_per_month),
    max(rownum) / sum(sesonal_adj_per_month) as adj
from
    tmp2
where
    rownum <= 12
;

 max_rownum |           sum           |          adj
------------+-------------------------+------------------------
         12 | 12.17504186583844506885 | 0.98562289413315371336
(1 row)
```

補正値で調整した季節調整値を計算する。これが`sesonal_adj_per_month_mod`。後先考えずに作業したせいで、名前が偉いことになっている。

```sql
with tmp as (
select
    d,
    y,
    extract(month from d) as m,
    case when
    count(*) over (order by d asc rows between 11 preceding and current row) = 12
    then avg(y) over (order by d asc rows between 11 preceding and current row)
    else null end as trend
from
    themepark
), tmp2 as (
select
    d,y,m,trend,
    y / trend as sesonal_adj,
    avg(y / trend) over (partition by m) as sesonal_adj_per_month,
    row_number () over (order by d asc) as rownum
from
    tmp
order by
    d asc
), tmp3 as (
select
    max(rownum) as max_rownum,
    sum(sesonal_adj_per_month) as sum_sesonal_adj_per_month,
    max(rownum) / sum(sesonal_adj_per_month) as adj
from
    tmp2
where
    rownum <= 12
)
select
    d,y,m,trend,sesonal_adj,sesonal_adj_per_month,
    max_rownum, sum_sesonal_adj_per_month, adj,
    sesonal_adj_per_month * adj as sesonal_adj_per_month_mod
from
    tmp2
cross join
    tmp3
;
     d      |   y   | m  |         trend          |      sesonal_adj       | sesonal_adj_per_month  | max_rownum | sum_sesonal_adj_per_month |          adj           |         sesonal_adj_per_month_mod
------------+-------+----+------------------------+------------------------+------------------------+------------+---------------------------+------------------------+--------------------------------------------
 2000-01-01 |  5222 |  1 |                        |                        | 0.99578248929620220818 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 0.9814660190272389797842158498845987672848
 2000-02-01 |  5464 |  2 |                        |                        | 1.07534593570604523640 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 1.0598855733449165436813258782267990383040
 2000-03-01 |  5430 |  3 |                        |                        | 0.99886070889974613945 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 0.9844999827416613583494397667290918880520
 2000-04-01 |  5245 |  4 |                        |                        | 0.97782366415812035248 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 0.9637653898194115073055729402505040851328
 2000-05-01 |  4887 |  5 |                        |                        | 0.91794428723466620537 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 0.9047469050372266529636719917451158727432
 2000-06-01 |  5721 |  6 |                        |                        | 1.02134144897621284102 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 1.0066575148380836440657600219715283300272
 2000-07-01 |  5016 |  7 |                        |                        | 0.98597823758139566395 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 0.9718027240772814184875616092063451853720
 2000-08-01 |  4543 |  8 |                        |                        | 0.83758903734782468589 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 0.8255469310849651421040333485045290964904
 2000-09-01 |  5583 |  9 |                        |                        | 1.05473487592504440247 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 1.0395708409524150563807006753917628559992
 2000-10-01 |  5546 | 10 |                        |                        | 1.07879719387760603364 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 1.0632872124123709929952692548863070774304
 2000-11-01 |  5881 | 11 |                        |                        |     1.0901695389693435 |         12 |   12.17504186583844506885 | 0.98562289413315371336 |     1.074496056094770240055816314226379160
 2000-12-01 |  6780 | 12 |  5443.1666666666666667 |     1.2455984567806730 |     1.1406744478662378 |         12 |   12.17504186583844506885 | 0.98562289413315371336 |     1.124274850569658463796450491642797008
 2001-01-01 |  5629 |  1 |  5477.0833333333333333 |     1.0277367820464055 | 0.99578248929620220818 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 0.9814660190272389797842158498845987672848
 2001-02-01 |  5841 |  2 |  5508.5000000000000000 |     1.0603612598711083 | 1.07534593570604523640 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 1.0598855733449165436813258782267990383040
 2001-03-01 |  5697 |  3 |  5530.7500000000000000 |     1.0300592143922614 | 0.99886070889974613945 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 0.9844999827416613583494397667290918880520
 2001-04-01 |  5547 |  4 |  5555.9166666666666667 | 0.99839510431821931574 | 0.97782366415812035248 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 0.9637653898194115073055729402505040851328
 2001-05-01 |  5069 |  5 |  5571.0833333333333333 | 0.90987689408104348347 | 0.91794428723466620537 |         12 |   12.17504186583844506885 | 0.98562289413315371336 | 0.9047469050372266529636719917451158727432
```

最後はこの季節調整値で現系列を割れば、季節性が取り除かれたデータが計算できる。

```sql
with tmp as (
select
    d,
    y,
    extract(month from d) as m,
    case when
    count(*) over (order by d asc rows between 11 preceding and current row) = 12
    then avg(y) over (order by d asc rows between 11 preceding and current row)
    else null end as trend
from
    themepark
), tmp2 as (
select
    d,y,m,trend,
    y / trend as sesonal_adj,
    avg(y / trend) over (partition by m) as sesonal_adj_per_month,
    row_number () over (order by d asc) as rownum
from
    tmp
order by
    d asc
), tmp3 as (
select
    max(rownum) as max_rownum,
    sum(sesonal_adj_per_month) as sum_sesonal_adj_per_month,
    max(rownum) / sum(sesonal_adj_per_month) as adj
from
    tmp2
where
    rownum <= 12
), tmp4 as (
select
    d,y,m,trend,sesonal_adj,sesonal_adj_per_month,
    max_rownum, sum_sesonal_adj_per_month, adj,
    sesonal_adj_per_month * adj as sesonal_adj_per_month_mod
from
    tmp2
cross join
    tmp3
)
select
    d,y,
    y / sesonal_adj_per_month_mod as sesonal_adjsuted_y
from
    tmp4
;

     d      |   y   |               sesonal_adjsuted_y
------------+-------+------------------------------------------------
 2000-01-01 |  5222 |  5320.6121238671962150921168926210301895890866
 2000-02-01 |  5464 |  5155.2734912279637998937916124472625742145410
 2000-03-01 |  5430 |  5515.4901931825266923785817854458393496841221
 2000-04-01 |  5245 |  5442.1958449688652386560604958046591189135886
 2000-05-01 |  4887 |  5401.5106023478685890910022317183247829212873
 2000-06-01 |  5721 |  5683.1642496804856669490153238222446941255132
 2000-07-01 |  5016 |  5161.5414072466715564235157585717500326787288
 2000-08-01 |  4543 |  5503.0184583563490404213425391245193701004775
 2000-09-01 |  5583 |  5370.4853772976826346815374837762299977094796
 2000-10-01 |  5546 |  5215.9002151613519536146502005723559728876253
 2000-11-01 |  5881 |      5473.263458382854695336666229327658999418
 2000-12-01 |  6780 |      6030.553824596044261275441918641150830153
 2001-01-01 |  5629 |  5735.2979021923491947057690518122901067018323
 2001-02-01 |  5841 |  5510.9722661534656945789964876106260424573817
 2001-03-01 |  5697 |  5786.6938546152586678601805583213529972652751
 2001-04-01 |  5547 |  5755.5501147840410827121387169167672321475074
 2001-05-01 |  5069 |  5602.6718320649367460819092106773456772310222
```

グレーの線は現系列。赤は季節調整済み系列。グレーの線だと 2011 年 3 月の東日本大震災、2020 年あたりのコロナの影響がわかりにくいが、季節調整済み系列を見ると、このあたりが季節調整されているので、わかりやすくなっている。

![line](https://github.com/SugiAki1989/sql_note/blob/main/image/p077-1-linechart.png)

## :closed_book: Reference

- [特定サービス産業動態統計調査](https://www.meti.go.jp/statistics/tyo/tokusabido/result/result_1.html)
- [第４章 季節調整の考え方](https://www.meti.go.jp/statistics/tyo/iip/riyou-4.pdf)
