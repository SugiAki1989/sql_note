## :memo: Overview

店舗の営業時間が深夜まで開店しており、実際の日付基準ではなく、営業日単位基準でデータを集計したい場合の方法についてまとめる。

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`json`, `a`, `a`

## :pencil2: Example

ここでは深夜 1 時まで開店しているお店があるとする。深夜営業時間は前日の売上として集計したい。このようなケースでは、日時を深夜営業時間分引くことで集計範囲を変更できる。

```sql
with tmp as (
select createdat, round((random() * (1 - 100))::numeric, 0) + 100 as value
from generate_series('2022-09-01 20:00:00'::timestamp with time zone,
					 '2022-09-03 10:00:00'::timestamp with time zone,
					 '30 minute') as createdat
)
select
    value, createdat,
    cast(createdat - '1 hours'::interval as text) as modat,
    substring(cast(createdat - '1 hours'::interval as text),1,10) as modymd
from
    tmp
;

 value |       createdat        |         modat          |   modymd
-------+------------------------+------------------------+------------
(snip)
    66 | 2022-09-01 23:00:00+09 | 2022-09-01 22:00:00+09 | 2022-09-01
    50 | 2022-09-01 23:30:00+09 | 2022-09-01 22:30:00+09 | 2022-09-01
    36 | 2022-09-02 00:00:00+09 | 2022-09-01 23:00:00+09 | 2022-09-01 -- 本当は9/2だけど深夜営業があるので、9/1として集計
    55 | 2022-09-02 00:30:00+09 | 2022-09-01 23:30:00+09 | 2022-09-01 -- 本当は9/2だけど深夜営業があるので、9/1として集計
    99 | 2022-09-02 01:00:00+09 | 2022-09-02 00:00:00+09 | 2022-09-02 -- ここから9/2として集計
     7 | 2022-09-02 01:30:00+09 | 2022-09-02 00:30:00+09 | 2022-09-02 -- 9/2として集計
    91 | 2022-09-02 02:00:00+09 | 2022-09-02 01:00:00+09 | 2022-09-02 -- 9/2として集計
    85 | 2022-09-02 02:30:00+09 | 2022-09-02 01:30:00+09 | 2022-09-02 -- 9/2として集計
    19 | 2022-09-02 03:00:00+09 | 2022-09-02 02:00:00+09 | 2022-09-02 -- 9/2として集計
(snip)
    33 | 2022-09-02 23:00:00+09 | 2022-09-02 22:00:00+09 | 2022-09-02 -- 9/2として集計
    38 | 2022-09-02 23:30:00+09 | 2022-09-02 22:30:00+09 | 2022-09-02 -- 9/2として集計
    18 | 2022-09-03 00:00:00+09 | 2022-09-02 23:00:00+09 | 2022-09-02 -- 本当は9/3だけど深夜営業があるので、9/2として集計
    18 | 2022-09-03 00:30:00+09 | 2022-09-02 23:30:00+09 | 2022-09-02 -- 本当は9/3だけど深夜営業があるので、9/2として集計
    61 | 2022-09-03 01:00:00+09 | 2022-09-03 00:00:00+09 | 2022-09-03 -- ここから9/3として集計
    71 | 2022-09-03 01:30:00+09 | 2022-09-03 00:30:00+09 | 2022-09-03
    97 | 2022-09-03 02:00:00+09 | 2022-09-03 01:00:00+09 | 2022-09-03
    54 | 2022-09-03 02:30:00+09 | 2022-09-03 01:30:00+09 | 2022-09-03
    83 | 2022-09-03 03:00:00+09 | 2022-09-03 02:00:00+09 | 2022-09-03
    92 | 2022-09-03 03:30:00+09 | 2022-09-03 02:30:00+09 | 2022-09-03
    63 | 2022-09-03 04:00:00+09 | 2022-09-03 03:00:00+09 | 2022-09-03
    39 | 2022-09-03 04:30:00+09 | 2022-09-03 03:30:00+09 | 2022-09-03
(snip)
```

このように全データをずらすだけで良いのであれば簡単だが、ずらした日付でのアクションをもとに実際の日時と絡めてなにか集計するとか、日によっては深夜営業時間が異なるとかになると、面倒なので注意が必要。

## :closed_book: Reference

None
