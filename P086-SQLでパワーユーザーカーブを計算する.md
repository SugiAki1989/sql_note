## :memo: Overview

ここでは、下記を参考にパワーユーザーカーブを計算する方法をまとめておく。

- [SaaS アナリティクス・ワークショップ 第 4 回： エンゲージメント Part 2 - パワーユーザー・カーブ](https://exploratory.io/note/BWz1Bar4JF/SaaS-4-Part-2-DMN9ely0Ik)
- [スタートアップのためのパワーユーザー・カーブ分析](https://exploratory.io/note/kanaugust/8618816952756796)

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`data analysis`

## :pencil2: Example

集計方針は、短いが、下記の通り。短く書くこともできるが、ここでは段階をおって集計過程を可視化する。

1. 月ごとのユーザーの利用日数を集計して可視化

サンプルデータを下記の通り用意する。

```sql
create table powerusercurve(
timestamp timestamp with time zone,
segment	varchar(255),
userid varchar(255),
event_type varchar(255),
country varchar(255)
);
COPY powerusercurve FROM '/Users/aki/Desktop/powerusercurve.csv' WITH CSV HEADER;

select * from powerusercurve limit 10;
       timestamp        |   segment   |   userid   | event_type | country
------------------------+-------------+------------+------------+---------
 2016-11-01 09:00:12+09 | Comedy      | 53b832deb5 | LOGIN      | Japan
 2016-11-01 09:00:13+09 | Human Drama | 6bfcdff572 | LOGIN      | Japan
 2016-11-01 09:00:15+09 | Comedy      | 53b832deb5 | LOGIN      | Japan
 2016-11-01 09:00:59+09 | Human Drama | 6bfcdff572 | LOGIN      | Japan
 2016-11-01 09:02:34+09 | Comedy      | 53b832deb5 | LOGIN      | Japan
 2016-11-01 09:03:42+09 | Comedy      | 53b832deb5 | LOGIN      | Japan
 2016-11-01 09:03:46+09 | Comedy      | 53b832deb5 | LOGIN      | Japan
 2016-11-01 09:03:56+09 | Comedy      | 53b832deb5 | LOGIN      | Japan
 2016-11-01 09:05:34+09 | Comedy      | 53b832deb5 | LOGIN      | Japan
 2016-11-01 09:05:37+09 | Comedy      | 53b832deb5 | LOGIN      | Japan
(10 rows)
```

`timestamp`を月ごと、日ごとに丸めておく。こうすることで、ユーザーが各月に何日利用しているかを集計できる。

```sql
with tmp as (
select
    userid,
    segment,
    timestamp,
    date_trunc('month', timestamp) as ym,
    date_trunc('day', timestamp) as ymd
from
    powerusercurve
-- where userid = '055b7f308d'
) select * from tmp limit 20;

   userid   |   segment   |       timestamp        |           ym           |          ymd
------------+-------------+------------------------+------------------------+------------------------
 53b832deb5 | Comedy      | 2016-11-01 09:00:12+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 6bfcdff572 | Human Drama | 2016-11-01 09:00:13+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 53b832deb5 | Comedy      | 2016-11-01 09:00:15+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 6bfcdff572 | Human Drama | 2016-11-01 09:00:59+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 53b832deb5 | Comedy      | 2016-11-01 09:02:34+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 53b832deb5 | Comedy      | 2016-11-01 09:03:42+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 53b832deb5 | Comedy      | 2016-11-01 09:03:46+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 53b832deb5 | Comedy      | 2016-11-01 09:03:56+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 53b832deb5 | Comedy      | 2016-11-01 09:05:34+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 53b832deb5 | Comedy      | 2016-11-01 09:05:37+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 53b832deb5 | Comedy      | 2016-11-01 09:05:48+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 af0e1e529a | Comedy      | 2016-11-01 09:06:41+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 42d6abe46b | Human Drama | 2016-11-01 09:08:43+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 42d6abe46b | Human Drama | 2016-11-01 09:08:44+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 42d6abe46b | Human Drama | 2016-11-01 09:08:56+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 42d6abe46b | Human Drama | 2016-11-01 09:10:27+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 42d6abe46b | Human Drama | 2016-11-01 09:10:28+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 42d6abe46b | Human Drama | 2016-11-01 09:10:42+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 162bece992 | Human Drama | 2016-11-01 09:12:01+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
 162bece992 | Human Drama | 2016-11-01 09:12:02+09 | 2016-11-01 00:00:00+09 | 2016-11-01 00:00:00+09
(20 rows)
```

この段階では、月ごとに各ユーザーの利用日数が集計できている。

```sql
with tmp as (
select
    userid,
    segment,
    timestamp,
    date_trunc('month', timestamp) as ym,
    date_trunc('day', timestamp) as ymd
from
    powerusercurve
-- where userid = '055b7f308d'
) -- select * from tmp limit 20;
, tmp2 as (
select
    ym,
    userid,
    count(distinct ymd) as freq
from
    tmp
group by
    ym,
    userid
order by
    freq desc
) select * from tmp2 limit 20;

           ym           |                userid                | freq
------------------------+--------------------------------------+------
 2017-01-01 00:00:00+09 | 4f47b6d4-fd60-4654-b716-5af1d22acb9a |   31
 2017-01-01 00:00:00+09 | 6002b958-e34f-455a-b7a1-01ee57a56028 |   31
 2017-01-01 00:00:00+09 | 425f9fd1-d8ba-4809-a655-4f92edeaa334 |   31
 2017-01-01 00:00:00+09 | 4c8124da7c                           |   31
 2017-01-01 00:00:00+09 | 56e2b7b2-f0e3-437e-b85a-d615f0190bdb |   31
 2017-01-01 00:00:00+09 | 11248c23-6777-44cc-8ee2-7afd0637f614 |   31
 2017-01-01 00:00:00+09 | 2b42f1db-37f8-4452-a918-ed4a86232279 |   31
 2017-01-01 00:00:00+09 | 406075da-9485-41b5-adf9-1a57c1f68b8b |   31
 2017-01-01 00:00:00+09 | 1b55c81e-ffd6-42a8-997c-3fbe505c7842 |   31
 2016-12-01 00:00:00+09 | de4bb5027b                           |   31
 2017-01-01 00:00:00+09 | 2e7057fb-8cd6-4850-b8fb-26b0402a475f |   31
 2017-01-01 00:00:00+09 | 567a8baf-17d4-4342-92d1-793998ee3ecc |   31
 2016-12-01 00:00:00+09 | 19c6061256                           |   31
 2017-01-01 00:00:00+09 | 094273bf-a28b-437a-8aeb-a89c4cc1ef74 |   31
 2017-01-01 00:00:00+09 | 162264e0-bb45-4d59-9da2-3bae8f1fb04b |   31
 2017-01-01 00:00:00+09 | 20a842a5-1ef3-4ef6-b6a3-b0b8413915ff |   31
 2017-01-01 00:00:00+09 | 21a03ef2-d023-4bfb-9a51-fc25dd1c9d02 |   31
 2017-01-01 00:00:00+09 | 3f3adf44-76b5-44f4-8f25-84e7bb0227d1 |   31
 2016-12-01 00:00:00+09 | 4c8124da7c                           |   31
 2017-01-01 00:00:00+09 | 69344a28-e087-408a-a3ca-9e06c9f7fd4b |   31
(20 rows)
```

あとは月ごと利用日数ごとにユーザー数を集計する。

```sql
with tmp as (
select
    userid,
    segment,
    timestamp,
    date_trunc('month', timestamp) as ym,
    date_trunc('day', timestamp) as ymd
from
    powerusercurve
-- where userid = '055b7f308d'
) -- select * from tmp limit 20;
, tmp2 as (
select
    ym,
    userid,
    count(distinct ymd) as freq
from
    tmp
group by
    ym,
    userid
order by
    freq desc
) -- select * from tmp2 limit 20;
select
    substr(ym::text,1,7),
    freq,
    count(userid) as cnt,
    lpad('+', floor(count(1)/5)::integer, '+') as hist
from
    tmp2
group by
    ym,
    freq
order by
    ym asc,
    freq asc
;

 substr  | freq | cnt |                         hist
---------+------+-----+------------------------------------------------------
 2016-11 |    1 | 219 | +++++++++++++++++++++++++++++++++++++++++++
 2016-11 |    2 |  87 | +++++++++++++++++
 2016-11 |    3 |  55 | +++++++++++
 2016-11 |    4 |  22 | ++++
 2016-11 |    5 |  18 | +++
 2016-11 |    6 |  13 | ++
 2016-11 |    7 |  13 | ++
 2016-11 |    8 |  10 | ++
 2016-11 |    9 |   5 | +
 2016-11 |   10 |   7 | +
 2016-11 |   11 |   9 | +
 2016-11 |   12 |   3 |
 2016-11 |   13 |   5 | +
 2016-11 |   14 |   5 | +
 2016-11 |   15 |   2 |
 2016-11 |   16 |   4 |
 2016-11 |   17 |   1 |
 2016-11 |   18 |   1 |
 2016-11 |   19 |   2 |
 2016-11 |   20 |   1 |
 2016-11 |   21 |   3 |
 2016-11 |   22 |   1 |
 2016-11 |   23 |   1 |
 2016-11 |   24 |   2 |
 2016-11 |   25 |   1 |
 2016-11 |   26 |   1 |
 2016-11 |   27 |   1 |
 2016-11 |   29 |   1 |
 2016-11 |   30 |   1 |
 2016-12 |    1 | 230 | ++++++++++++++++++++++++++++++++++++++++++++++
 2016-12 |    2 |  73 | ++++++++++++++
 2016-12 |    3 |  38 | +++++++
 2016-12 |    4 |  33 | ++++++
 2016-12 |    5 |  22 | ++++
 2016-12 |    6 |  13 | ++
 2016-12 |    7 |   7 | +
 2016-12 |    8 |   3 |
 2016-12 |    9 |  10 | ++
 2016-12 |   10 |   6 | +
 2016-12 |   11 |   3 |
 2016-12 |   12 |   2 |
 2016-12 |   13 |   3 |
 2016-12 |   14 |   7 | +
 2016-12 |   16 |   5 | +
 2016-12 |   17 |   1 |
 2016-12 |   18 |   1 |
 2016-12 |   20 |   2 |
 2016-12 |   21 |   1 |
 2016-12 |   22 |   1 |
 2016-12 |   23 |   1 |
 2016-12 |   28 |   1 |
 2016-12 |   30 |   2 |
 2016-12 |   31 |   3 |
 2017-01 |    1 | 262 | ++++++++++++++++++++++++++++++++++++++++++++++++++++
 2017-01 |    2 | 113 | ++++++++++++++++++++++
 2017-01 |    3 |  45 | +++++++++
 2017-01 |    4 |  21 | ++++
 2017-01 |    5 |  21 | ++++
 2017-01 |    6 |  14 | ++
 2017-01 |    7 |  16 | +++
 2017-01 |    8 |  11 | ++
 2017-01 |    9 |  12 | ++
 2017-01 |   10 |   6 | +
 2017-01 |   11 |   3 |
 2017-01 |   12 |   4 |
 2017-01 |   13 |   5 | +
 2017-01 |   14 |   2 |
 2017-01 |   15 |   3 |
 2017-01 |   16 |   8 | +
 2017-01 |   17 |   2 |
 2017-01 |   18 |   2 |
 2017-01 |   20 |   2 |
 2017-01 |   22 |   1 |
 2017-01 |   23 |   2 |
 2017-01 |   24 |   3 |
 2017-01 |   25 |   4 |
 2017-01 |   26 |   7 | +
 2017-01 |   27 |  11 | ++
 2017-01 |   28 |  18 | +++
 2017-01 |   29 |  27 | +++++
 2017-01 |   30 |  29 | +++++
 2017-01 |   31 |  38 | +++++++
(82 rows)
```

## :closed_book: Reference

- [SaaS アナリティクス・ワークショップ 第 4 回： エンゲージメント Part 2 - パワーユーザー・カーブ](https://exploratory.io/note/BWz1Bar4JF/SaaS-4-Part-2-DMN9ely0Ik)
