## :memo: Overview

何らかの施設や店舗など、利用者の入場時刻と退出時刻のデータから 10 分ごとの利用人数を計算する方法をまとめておく。

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`to_timestamp`, `trunc`, `extract`

## :pencil2: Example

何らかの施設や店舗など、利用者の入場時刻と退出時刻のデータがあるとする。ら 10 分ごとの利用人数を集計しようとすると、開始と終了しかないので、このデータだと中間の時間帯ではデータがないので、集計しようがない。そこを修正する必要がある。

```sql
create table inout(
    cuid integer,
    in_time timestamp with time zone,
    out_time timestamp with time zone
);

insert into inout(cuid, in_time, out_time)
values
    ('1' ,'2022-09-01 08:00:00','2022-09-01 10:30:00'),
    ('2' ,'2022-09-01 10:15:00','2022-09-01 10:45:00'),

    ('3' ,'2022-09-01 10:27:00','2022-09-01 11:57:00'),-- 前 前
    ('4' ,'2022-09-01 10:27:00','2022-09-01 12:00:00'),-- 前 中間
    ('5' ,'2022-09-01 10:27:00','2022-09-01 12:03:00'),-- 前 後

    ('6' ,'2022-09-01 10:30:00','2022-09-01 11:57:00'),-- 中間 前
    ('7' ,'2022-09-01 10:30:00','2022-09-01 12:00:00'),-- 中間 中間
    ('8' ,'2022-09-01 10:30:00','2022-09-01 12:03:00'),-- 中間 後

    ('9' ,'2022-09-01 10:33:00','2022-09-01 11:57:00'),-- 後 前
    ('10','2022-09-01 10:33:00','2022-09-01 12:00:00'),-- 後 中間
    ('11','2022-09-01 10:33:00','2022-09-01 12:03:00') -- 後 後
    ;

select * from inout;
 cuid |        in_time         |        out_time
------+------------------------+------------------------
    1 | 2022-09-01 08:00:00+09 | 2022-09-01 10:30:00+09
    2 | 2022-09-01 10:15:00+09 | 2022-09-01 10:45:00+09
    3 | 2022-09-01 10:27:00+09 | 2022-09-01 11:57:00+09
    4 | 2022-09-01 10:27:00+09 | 2022-09-01 12:00:00+09
    5 | 2022-09-01 10:27:00+09 | 2022-09-01 12:03:00+09
    6 | 2022-09-01 10:30:00+09 | 2022-09-01 11:57:00+09
    7 | 2022-09-01 10:30:00+09 | 2022-09-01 12:00:00+09
    8 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09
    9 | 2022-09-01 10:33:00+09 | 2022-09-01 11:57:00+09
   10 | 2022-09-01 10:33:00+09 | 2022-09-01 12:00:00+09
   11 | 2022-09-01 10:33:00+09 | 2022-09-01 12:03:00+09
(11 rows)
```

修正は`generate_series`で 10 分ごとの時間を生成し、これを紐付ければよいのだが、生成した時間と記録されている時間の単位が異なるので、一部修正する必要がある。例えば、`10:27`に開始した場合、`10:20`の集計時間ではカウントされる必要がある。

```sql
with run as (
select run_time
from generate_series('2022-09-01 07:00:00'::timestamp with time zone,
				     '2022-09-01 13:00:00'::timestamp with time zone,
					 '10 minute') as run_time
), tmp2 as (
select
    cuid,
    run_time,
    in_time,
    to_timestamp(trunc(extract(epoch from in_time) / 600, 0) * 600) as intime_mod,
    out_time,
    to_timestamp(trunc(extract(epoch from out_time) / 600, 0) * 600) as outtime_mod
from inout
cross join
    run
)
select
    cuid,
    run_time,
    in_time,
    intime_mod,
    out_time,
    outtime_mod,
    case when in_time <= run_time and run_time <= out_time then 'exist' else 'not exist' end exist_flag,
    case when intime_mod <= run_time and run_time <= outtime_mod then 'exist' else 'not exist' end exist_flagmod
from
    tmp2
order by cuid asc, in_time asc, run_time asc
;

 cuid |        run_time        |        in_time         |       intime_mod       |        out_time        |      outtime_mod       | exist_flag | exist_flagmod
------+------------------------+------------------------+------------------------+------------------------+------------------------+------------+---------------
-- --in
    1 | 2022-09-01 07:50:00+09 | 2022-09-01 08:00:00+09 | 2022-09-01 08:00:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | not exist  | not exist
    1 | 2022-09-01 08:00:00+09 | 2022-09-01 08:00:00+09 | 2022-09-01 08:00:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | exist      | exist
-- --out
    1 | 2022-09-01 10:30:00+09 | 2022-09-01 08:00:00+09 | 2022-09-01 08:00:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | exist      | exist
    1 | 2022-09-01 10:40:00+09 | 2022-09-01 08:00:00+09 | 2022-09-01 08:00:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | not exist  | not exist

-- --in
    2 | 2022-09-01 10:00:00+09 | 2022-09-01 10:15:00+09 | 2022-09-01 10:10:00+09 | 2022-09-01 10:45:00+09 | 2022-09-01 10:40:00+09 | not exist  | not exist
    2 | 2022-09-01 10:10:00+09 | 2022-09-01 10:15:00+09 | 2022-09-01 10:10:00+09 | 2022-09-01 10:45:00+09 | 2022-09-01 10:40:00+09 | not exist  | exist
    2 | 2022-09-01 10:20:00+09 | 2022-09-01 10:15:00+09 | 2022-09-01 10:10:00+09 | 2022-09-01 10:45:00+09 | 2022-09-01 10:40:00+09 | exist      | exist
-- --out
    2 | 2022-09-01 10:40:00+09 | 2022-09-01 10:15:00+09 | 2022-09-01 10:10:00+09 | 2022-09-01 10:45:00+09 | 2022-09-01 10:40:00+09 | exist      | exist
    2 | 2022-09-01 10:50:00+09 | 2022-09-01 10:15:00+09 | 2022-09-01 10:10:00+09 | 2022-09-01 10:45:00+09 | 2022-09-01 10:40:00+09 | not exist  | not exist

-- --in
    3 | 2022-09-01 10:10:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | not exist  | not exist
    3 | 2022-09-01 10:20:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | not exist  | exist
    3 | 2022-09-01 10:30:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | exist      | exist
-- --out
    3 | 2022-09-01 11:50:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | exist      | exist
    3 | 2022-09-01 12:00:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | not exist  | not exist

-- --in
    4 | 2022-09-01 10:10:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | not exist  | not exist
    4 | 2022-09-01 10:20:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | not exist  | exist
    4 | 2022-09-01 10:30:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
-- --out
    4 | 2022-09-01 11:50:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
    4 | 2022-09-01 12:00:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
    4 | 2022-09-01 12:10:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | not exist  | not exist

-- --in
    5 | 2022-09-01 10:10:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | not exist  | not exist
    5 | 2022-09-01 10:20:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | not exist  | exist
    5 | 2022-09-01 10:30:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
-- --out
    5 | 2022-09-01 12:00:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
    5 | 2022-09-01 12:10:00+09 | 2022-09-01 10:27:00+09 | 2022-09-01 10:20:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | not exist  | not exist

-- --in
    6 | 2022-09-01 10:20:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | not exist  | not exist
    6 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | exist      | exist
    6 | 2022-09-01 10:40:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | exist      | exist
-- --out
    6 | 2022-09-01 11:40:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | exist      | exist
    6 | 2022-09-01 11:50:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | exist      | exist
    6 | 2022-09-01 12:00:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | not exist  | not exist

-- --in
    7 | 2022-09-01 10:20:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | not exist  | not exist
    7 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
    7 | 2022-09-01 10:40:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
-- --out
    7 | 2022-09-01 11:50:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
    7 | 2022-09-01 12:00:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
    7 | 2022-09-01 12:10:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | not exist  | not exist

-- --in
    8 | 2022-09-01 10:20:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | not exist  | not exist
    8 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
    8 | 2022-09-01 10:40:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
-- --out
    8 | 2022-09-01 11:50:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
    8 | 2022-09-01 12:00:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
    8 | 2022-09-01 12:10:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | not exist  | not exist

-- --in
    9 | 2022-09-01 10:20:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | not exist  | not exist
    9 | 2022-09-01 10:30:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | not exist  | exist
    9 | 2022-09-01 10:40:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | exist      | exist
-- --out
    9 | 2022-09-01 11:50:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | exist      | exist
    9 | 2022-09-01 12:00:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 11:57:00+09 | 2022-09-01 11:50:00+09 | not exist  | not exist

-- --in
   10 | 2022-09-01 10:20:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | not exist  | not exist
   10 | 2022-09-01 10:30:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | not exist  | exist
   10 | 2022-09-01 10:40:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
-- --out
   10 | 2022-09-01 12:00:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
   10 | 2022-09-01 12:10:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:00:00+09 | 2022-09-01 12:00:00+09 | not exist  | not exist

-- --in
   11 | 2022-09-01 10:20:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | not exist  | not exist
   11 | 2022-09-01 10:30:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | not exist  | exist
   11 | 2022-09-01 10:40:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
-- --out
   11 | 2022-09-01 11:50:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
   11 | 2022-09-01 12:00:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | exist      | exist
   11 | 2022-09-01 12:10:00+09 | 2022-09-01 10:33:00+09 | 2022-09-01 10:30:00+09 | 2022-09-01 12:03:00+09 | 2022-09-01 12:00:00+09 | not exist  | not exist
```

あとは、`case`文の条件文を`join`の`on`に書き換えて、集計すれば 10 分単位の利用人数を計算できる。

```sql
with run as (
select run_time
from generate_series('2022-09-01 07:00:00'::timestamp with time zone,
				     '2022-09-01 13:00:00'::timestamp with time zone,
					 '10 minute') as run_time
), tmp2 as (
select
    cuid,
    in_time,
    to_timestamp(trunc(extract(epoch from in_time) / 600, 0) * 600) as intime_mod,
    out_time,
    to_timestamp(trunc(extract(epoch from out_time) / 600, 0) * 600) as outtime_mod
from inout
)
select
    run_time,
    count(cuid) as cnt,
    lpad('+', count(1)::integer, '+') as hist
from
    tmp2
left join
    run
on intime_mod <= run_time and run_time <= outtime_mod
group by
    run_time
order by
    run_time asc
;

        run_time        | cnt |    hist
------------------------+-----+-------------
 2022-09-01 08:00:00+09 |   1 | +
 2022-09-01 08:10:00+09 |   1 | +
 2022-09-01 08:20:00+09 |   1 | +
 2022-09-01 08:30:00+09 |   1 | +
 2022-09-01 08:40:00+09 |   1 | +
 2022-09-01 08:50:00+09 |   1 | +
 2022-09-01 09:00:00+09 |   1 | +
 2022-09-01 09:10:00+09 |   1 | +
 2022-09-01 09:20:00+09 |   1 | +
 2022-09-01 09:30:00+09 |   1 | +
 2022-09-01 09:40:00+09 |   1 | +
 2022-09-01 09:50:00+09 |   1 | +
 2022-09-01 10:00:00+09 |   1 | +
 2022-09-01 10:10:00+09 |   2 | ++
 2022-09-01 10:20:00+09 |   5 | +++++
 2022-09-01 10:30:00+09 |  11 | +++++++++++
 2022-09-01 10:40:00+09 |  10 | ++++++++++
 2022-09-01 10:50:00+09 |   9 | +++++++++
 2022-09-01 11:00:00+09 |   9 | +++++++++
 2022-09-01 11:10:00+09 |   9 | +++++++++
 2022-09-01 11:20:00+09 |   9 | +++++++++
 2022-09-01 11:30:00+09 |   9 | +++++++++
 2022-09-01 11:40:00+09 |   9 | +++++++++
 2022-09-01 11:50:00+09 |   9 | +++++++++
 2022-09-01 12:00:00+09 |   6 | ++++++
(25 rows)
```

## :closed_book: Reference

None
