## :memo: Overview

ここでは、特定のページの前後のレコードを抜き出す方法をまとめる。仕事で分析系のSQLを書いていると、ウェブサイトのログデータで、このページにアクセスしたときの前後のページを知りたいことがある。例えば、特定のユーザーが商品ページを見たときに、その前にどのページを見ていたか、またその後にどのページを見たかを知りたい場合など。1ページ前後だと簡単にlagやleadを使って前後のページを取得することもできるが、5ページ前後となると面倒なので、その対処方法をメモしておく。

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`ROW_NUMBER`

## :pencil2: Example

まずは、サンプルのテーブルを作成する。内容はシンプルなユーザーページログで、ユーザーID、イベント時間、ページの3つのカラムを持つ。

```sql
-- 1. テーブル作成
CREATE TABLE IF NOT EXISTS user_page_logs (
    id         serial PRIMARY KEY,
    user_id    int          NOT NULL,
    event_time timestamptz  NOT NULL,
    page       text         NOT NULL
);

-- 2. サンプルデータ挿入（1 000 行）
INSERT INTO user_page_logs (user_id, event_time, page)
SELECT
    (floor(random()*10) + 1)::int                    AS user_id,    -- 1〜10
    NOW() - (random() * INTERVAL '30 days')          AS event_time, -- 過去 30 日以内
    (ARRAY['/home', '/search', '/products', '/product/42', '/cart', '/checkout', '/blog', '/help'])[floor(random()*8)+1] AS page -- ランダムにページ作成
FROM generate_series(1, 1000);

select * from user_page_logs order by user_id, event_time limit 10;
 id  | user_id |          event_time           |    page
-----+---------+-------------------------------+-------------
 845 |       1 | 2025-06-13 18:26:22.549633+00 | /home
 908 |       1 | 2025-06-13 19:53:32.524914+00 | /help
 897 |       1 | 2025-06-14 00:33:07.757622+00 | /checkout
 827 |       1 | 2025-06-14 00:42:59.999562+00 | /cart
 236 |       1 | 2025-06-14 03:20:32.441587+00 | /product/42
 203 |       1 | 2025-06-14 05:52:34.085129+00 | /checkout
 134 |       1 | 2025-06-14 10:44:15.805447+00 | /search
 288 |       1 | 2025-06-15 02:16:41.498615+00 | /help
 710 |       1 | 2025-06-15 03:44:48.389402+00 | /products
 199 |       1 | 2025-06-15 09:26:55.194898+00 | /products
(10 rows)
```

ここでは、`/product/42`というページを見たときの前後のページを取得する例を示す。`/product/42`は1回だけアクセスされているわけではなく、複数回アクセスされることもあれば、1回もアクセスされないこともある。ここではユーザーIDが1と2のケースを考える。

まずは前後のページを取得するために、`ROW_NUMBER`を使って各ユーザーのイベントに番号を付与する。このあとに、この番号を使って前後のページを取得するための要素の1つになる。

```sql
 WITH ordered AS (
    SELECT
        user_id,
        event_time,
        page,
        ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY event_time) AS rn
    FROM user_page_logs
    WHERE user_id IN (1,2)
)
select * from ordered limit 100;
 user_id |          event_time           |    page     | rn
---------+-------------------------------+-------------+----
       1 | 2025-06-13 18:26:22.549633+00 | /home       |  1
       1 | 2025-06-13 19:53:32.524914+00 | /help       |  2
       1 | 2025-06-14 00:33:07.757622+00 | /checkout   |  3
       1 | 2025-06-14 00:42:59.999562+00 | /cart       |  4
       1 | 2025-06-14 03:20:32.441587+00 | /product/42 |  5
       1 | 2025-06-14 05:52:34.085129+00 | /checkout   |  6
       1 | 2025-06-14 10:44:15.805447+00 | /search     |  7
       1 | 2025-06-15 02:16:41.498615+00 | /help       |  8
       1 | 2025-06-15 03:44:48.389402+00 | /products   |  9
       1 | 2025-06-15 09:26:55.194898+00 | /products   | 10
       1 | 2025-06-15 11:31:11.086613+00 | /home       | 11
(snip)
       1 | 2025-07-11 18:13:12.218894+00 | /help       | 90
       1 | 2025-07-11 20:23:21.871222+00 | /products   | 91
       1 | 2025-07-12 00:32:44.186207+00 | /search     | 92
       1 | 2025-07-12 02:01:01.767857+00 | /products   | 93
       1 | 2025-07-12 04:47:13.827194+00 | /product/42 | 94
       1 | 2025-07-12 15:55:26.79915+00  | /search     | 95
       1 | 2025-07-13 00:53:40.94319+00  | /home       | 96
       2 | 2025-06-13 07:11:45.482418+00 | /products   |  1
       2 | 2025-06-13 09:30:36.402876+00 | /checkout   |  2
       2 | 2025-06-14 07:47:27.207383+00 | /search     |  3
       2 | 2025-06-14 13:47:13.750613+00 | /help       |  4
```

次は特定のページのレコードを抜き出す。これが前後のページの中心レコードとなる。

```sql
WITH ordered AS (
    SELECT
        user_id,
        event_time,
        page,
        ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY event_time) AS rn
    FROM user_page_logs
    WHERE user_id IN (1,2)
)
, center_rows AS (
    SELECT *
    FROM ordered
    WHERE page = '/product/42'
)
select * from center_rows limit 10; 
 user_id |          event_time           |    page     | rn
---------+-------------------------------+-------------+----
       1 | 2025-06-14 03:20:32.441587+00 | /product/42 |  5
       1 | 2025-06-18 08:01:47.738607+00 | /product/42 | 24
       1 | 2025-06-19 02:17:45.037087+00 | /product/42 | 27
       1 | 2025-06-28 18:40:57.010819+00 | /product/42 | 51
       1 | 2025-06-28 23:01:20.018892+00 | /product/42 | 53
       1 | 2025-06-30 19:00:49.262336+00 | /product/42 | 58
       1 | 2025-07-09 14:06:40.549344+00 | /product/42 | 84
       1 | 2025-07-12 04:47:13.827194+00 | /product/42 | 94
       2 | 2025-06-21 09:28:56.39246+00  | /product/42 | 28
       2 | 2025-06-22 06:17:49.755116+00 | /product/42 | 30
(10 rows)
```

最後に中心となるレコードに対して、番号をうまく利用して紐づけることで、前後のページを取得する。ここでは、中心のレコードから±3行の前後のページを取得する。検証のために残している`check1`,`center_rn`,`check2`をみると何をしているのかがわかりよい。あとは要件に応じて、±3行の部分を変更するなり、集計するなりすればよい。また、レコード範囲内の最初の特定ページだけに紐づけたければ、`center_rows`の部分で加工するとよい。

```sql
WITH ordered AS (
    SELECT
        user_id,
        event_time,
        page,
        ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY event_time) AS rn
    FROM user_page_logs
    WHERE user_id IN (1,2)
)
, center_rows AS (
    SELECT *
    FROM ordered
    WHERE page = '/product/42'
)
SELECT
    c.user_id,
    c.event_time   AS center_time,
    c.page         AS center_page,
    c.rn - 3       AS check1,
    c.rn           AS center_rn,
    c.rn + 3       AS check2,
    w.rn           AS around_rn,
    w.event_time   AS around_time,
    w.page         AS around_page
FROM center_rows        AS c
INNER JOIN ordered            AS w
  ON w.user_id = c.user_id
 AND w.rn BETWEEN c.rn - 3 AND c.rn + 3     -- ±3 行
ORDER BY c.user_id, c.event_time, center_rn, around_rn;

 user_id |          center_time          | center_page | check1 | center_rn | check2 | around_rn |          around_time          | around_page
---------+-------------------------------+-------------+--------+-----------+--------+-----------+-------------------------------+-------------
       1 | 2025-06-14 03:20:32.441587+00 | /product/42 |      2 |         5 |      8 |         2 | 2025-06-13 19:53:32.524914+00 | /help
       1 | 2025-06-14 03:20:32.441587+00 | /product/42 |      2 |         5 |      8 |         3 | 2025-06-14 00:33:07.757622+00 | /checkout
       1 | 2025-06-14 03:20:32.441587+00 | /product/42 |      2 |         5 |      8 |         4 | 2025-06-14 00:42:59.999562+00 | /cart
       1 | 2025-06-14 03:20:32.441587+00 | /product/42 |      2 |         5 |      8 |         5 | 2025-06-14 03:20:32.441587+00 | /product/42
       1 | 2025-06-14 03:20:32.441587+00 | /product/42 |      2 |         5 |      8 |         6 | 2025-06-14 05:52:34.085129+00 | /checkout
       1 | 2025-06-14 03:20:32.441587+00 | /product/42 |      2 |         5 |      8 |         7 | 2025-06-14 10:44:15.805447+00 | /search
       1 | 2025-06-14 03:20:32.441587+00 | /product/42 |      2 |         5 |      8 |         8 | 2025-06-15 02:16:41.498615+00 | /help
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
       1 | 2025-06-18 08:01:47.738607+00 | /product/42 |     21 |        24 |     27 |        21 | 2025-06-17 11:30:41.212484+00 | /products
       1 | 2025-06-18 08:01:47.738607+00 | /product/42 |     21 |        24 |     27 |        22 | 2025-06-17 14:03:03.920129+00 | /cart
       1 | 2025-06-18 08:01:47.738607+00 | /product/42 |     21 |        24 |     27 |        23 | 2025-06-17 18:54:41.818007+00 | /checkout
       1 | 2025-06-18 08:01:47.738607+00 | /product/42 |     21 |        24 |     27 |        24 | 2025-06-18 08:01:47.738607+00 | /product/42
       1 | 2025-06-18 08:01:47.738607+00 | /product/42 |     21 |        24 |     27 |        25 | 2025-06-18 12:48:11.112898+00 | /search
       1 | 2025-06-18 08:01:47.738607+00 | /product/42 |     21 |        24 |     27 |        26 | 2025-06-18 21:09:04.825704+00 | /blog
       1 | 2025-06-18 08:01:47.738607+00 | /product/42 |     21 |        24 |     27 |        27 | 2025-06-19 02:17:45.037087+00 | /product/42
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
       1 | 2025-06-19 02:17:45.037087+00 | /product/42 |     24 |        27 |     30 |        24 | 2025-06-18 08:01:47.738607+00 | /product/42
       1 | 2025-06-19 02:17:45.037087+00 | /product/42 |     24 |        27 |     30 |        25 | 2025-06-18 12:48:11.112898+00 | /search
       1 | 2025-06-19 02:17:45.037087+00 | /product/42 |     24 |        27 |     30 |        26 | 2025-06-18 21:09:04.825704+00 | /blog
       1 | 2025-06-19 02:17:45.037087+00 | /product/42 |     24 |        27 |     30 |        27 | 2025-06-19 02:17:45.037087+00 | /product/42
       1 | 2025-06-19 02:17:45.037087+00 | /product/42 |     24 |        27 |     30 |        28 | 2025-06-19 20:11:41.861479+00 | /blog
       1 | 2025-06-19 02:17:45.037087+00 | /product/42 |     24 |        27 |     30 |        29 | 2025-06-20 21:08:06.588751+00 | /blog
       1 | 2025-06-19 02:17:45.037087+00 | /product/42 |     24 |        27 |     30 |        30 | 2025-06-21 11:03:13.845695+00 | /checkout
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(snip)
       2 | 2025-06-21 09:28:56.39246+00  | /product/42 |     25 |        28 |     31 |        25 | 2025-06-20 10:15:54.317252+00 | /checkout
       2 | 2025-06-21 09:28:56.39246+00  | /product/42 |     25 |        28 |     31 |        26 | 2025-06-21 02:46:14.916386+00 | /checkout
       2 | 2025-06-21 09:28:56.39246+00  | /product/42 |     25 |        28 |     31 |        27 | 2025-06-21 06:46:56.038878+00 | /blog
       2 | 2025-06-21 09:28:56.39246+00  | /product/42 |     25 |        28 |     31 |        28 | 2025-06-21 09:28:56.39246+00  | /product/42
       2 | 2025-06-21 09:28:56.39246+00  | /product/42 |     25 |        28 |     31 |        29 | 2025-06-21 16:46:19.344715+00 | /checkout
       2 | 2025-06-21 09:28:56.39246+00  | /product/42 |     25 |        28 |     31 |        30 | 2025-06-22 06:17:49.755116+00 | /product/42
       2 | 2025-06-21 09:28:56.39246+00  | /product/42 |     25 |        28 |     31 |        31 | 2025-06-22 18:31:22.691078+00 | /products
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
       2 | 2025-06-22 06:17:49.755116+00 | /product/42 |     27 |        30 |     33 |        27 | 2025-06-21 06:46:56.038878+00 | /blog
       2 | 2025-06-22 06:17:49.755116+00 | /product/42 |     27 |        30 |     33 |        28 | 2025-06-21 09:28:56.39246+00  | /product/42
       2 | 2025-06-22 06:17:49.755116+00 | /product/42 |     27 |        30 |     33 |        29 | 2025-06-21 16:46:19.344715+00 | /checkout
       2 | 2025-06-22 06:17:49.755116+00 | /product/42 |     27 |        30 |     33 |        30 | 2025-06-22 06:17:49.755116+00 | /product/42
       2 | 2025-06-22 06:17:49.755116+00 | /product/42 |     27 |        30 |     33 |        31 | 2025-06-22 18:31:22.691078+00 | /products
       2 | 2025-06-22 06:17:49.755116+00 | /product/42 |     27 |        30 |     33 |        32 | 2025-06-23 14:47:11.602995+00 | /help
       2 | 2025-06-22 06:17:49.755116+00 | /product/42 |     27 |        30 |     33 |        33 | 2025-06-25 07:01:47.890157+00 | /products
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
       2 | 2025-06-29 14:45:47.067196+00 | /product/42 |     40 |        43 |     46 |        40 | 2025-06-27 23:22:18.249401+00 | /search
       2 | 2025-06-29 14:45:47.067196+00 | /product/42 |     40 |        43 |     46 |        41 | 2025-06-28 06:46:14.920241+00 | /home
       2 | 2025-06-29 14:45:47.067196+00 | /product/42 |     40 |        43 |     46 |        42 | 2025-06-29 01:01:33.771644+00 | /products
       2 | 2025-06-29 14:45:47.067196+00 | /product/42 |     40 |        43 |     46 |        43 | 2025-06-29 14:45:47.067196+00 | /product/42
       2 | 2025-06-29 14:45:47.067196+00 | /product/42 |     40 |        43 |     46 |        44 | 2025-06-29 16:34:46.971451+00 | /checkout
       2 | 2025-06-29 14:45:47.067196+00 | /product/42 |     40 |        43 |     46 |        45 | 2025-06-29 21:35:39.18247+00  | /help
       2 | 2025-06-29 14:45:47.067196+00 | /product/42 |     40 |        43 |     46 |        46 | 2025-06-30 06:56:22.811799+00 | /product/42
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(snip)
       2 | 2025-07-10 03:55:23.69653+00  | /product/42 |     90 |        93 |     96 |        90 | 2025-07-10 02:47:52.810404+00 | /home
       2 | 2025-07-10 03:55:23.69653+00  | /product/42 |     90 |        93 |     96 |        91 | 2025-07-10 03:33:22.182054+00 | /cart
       2 | 2025-07-10 03:55:23.69653+00  | /product/42 |     90 |        93 |     96 |        92 | 2025-07-10 03:38:25.510808+00 | /blog
       2 | 2025-07-10 03:55:23.69653+00  | /product/42 |     90 |        93 |     96 |        93 | 2025-07-10 03:55:23.69653+00  | /product/42
       2 | 2025-07-10 03:55:23.69653+00  | /product/42 |     90 |        93 |     96 |        94 | 2025-07-10 11:39:35.188426+00 | /blog
       2 | 2025-07-10 03:55:23.69653+00  | /product/42 |     90 |        93 |     96 |        95 | 2025-07-10 20:22:01.283822+00 | /cart
       2 | 2025-07-10 03:55:23.69653+00  | /product/42 |     90 |        93 |     96 |        96 | 2025-07-11 03:59:25.916524+00 | /blog
(139 rows)
```

## :closed_book: Reference

- none