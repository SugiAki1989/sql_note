## :memo: Overview

Preppin' Data challenge の「2019: Week 1」の問題を SQL で解答する。問題文と解答は下記の公式サイトより確認下さい。

- [Question](https://preppindata.blogspot.com/2019/02/2019-week-1.html)
- [Answer](https://preppindata.blogspot.com/2019/02/2019-week-1-solution.html)

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`Preppin'Data challenge`

## :pencil2: Example

提供されたデータこちら。車の販売データがあって、車種べつにどれだけ販売されたかを計算するのがお題。

```sql
select * from p2019w01t1 limit 10;
 dealership | red_cars | silver_cars | black_cars | blue_cars | when_sold_month | when_sold_year
------------+----------+-------------+------------+-----------+-----------------+----------------
 A          |      451 |         325 |        377 |       396 |               1 |           2018
 A          |      355 |         238 |        259 |       246 |               2 |           2018
 A          |      124 |         456 |        303 |       175 |               3 |           2018
 A          |      391 |         456 |        429 |       223 |               4 |           2018
 A          |      139 |         177 |        241 |       376 |               5 |           2018
 A          |      345 |         311 |        413 |       126 |               6 |           2018
 A          |      257 |         428 |        118 |       184 |               7 |           2018
 A          |      122 |         392 |        280 |       269 |               8 |           2018
 A          |      217 |         124 |        149 |       252 |               9 |           2018
 A          |      164 |         147 |        252 |       113 |              10 |           2018
(10 rows)
```

日付の形式を整えて、各色ごとに車の販売台数を合計すればよい。これで最初の Preppin' Data challenge はおしまい。

```sql
select
    dealership,
    (when_sold_year::text || '-' || when_sold_month::text || '-01')::date as dt,
    red_cars,
    silver_cars,
    black_cars,
    blue_cars,
    red_cars + silver_cars + black_cars + blue_cars as total_cars
from
    p2019w01t1
order by
    dealership asc,
    dt asc
;

 dealership |     dt     | red_cars | silver_cars | black_cars | blue_cars | total_cars
------------+------------+----------+-------------+------------+-----------+------------
 A          | 2018-01-01 |      451 |         325 |        377 |       396 |       1549
 A          | 2018-02-01 |      355 |         238 |        259 |       246 |       1098
 A          | 2018-03-01 |      124 |         456 |        303 |       175 |       1058
 A          | 2018-04-01 |      391 |         456 |        429 |       223 |       1499
 A          | 2018-05-01 |      139 |         177 |        241 |       376 |        933
 A          | 2018-06-01 |      345 |         311 |        413 |       126 |       1195
 A          | 2018-07-01 |      257 |         428 |        118 |       184 |        987
 A          | 2018-08-01 |      122 |         392 |        280 |       269 |       1063
 A          | 2018-09-01 |      217 |         124 |        149 |       252 |        742
 A          | 2018-10-01 |      164 |         147 |        252 |       113 |        676
 A          | 2018-11-01 |      220 |         354 |        266 |       168 |       1008
 A          | 2018-12-01 |      366 |         305 |        397 |       135 |       1203
 A          | 2019-01-01 |      367 |         180 |        255 |       107 |        909
 A          | 2019-02-01 |      400 |         382 |        269 |       309 |       1360
 A          | 2019-03-01 |      305 |         247 |        202 |       222 |        976
 A          | 2019-04-01 |      132 |         239 |        415 |       452 |       1238
 A          | 2019-05-01 |      145 |         237 |        361 |       310 |       1053
 A          | 2019-06-01 |      146 |         303 |        240 |       353 |       1042
 A          | 2019-07-01 |      346 |         315 |        205 |       242 |       1108
 A          | 2019-08-01 |      348 |         234 |        421 |       189 |       1192
 A          | 2019-09-01 |      112 |         118 |        414 |       385 |       1029
 A          | 2019-10-01 |      139 |         266 |        435 |       219 |       1059
 A          | 2019-11-01 |      325 |         124 |        460 |       297 |       1206
 A          | 2019-12-01 |      247 |         336 |        130 |       265 |        978
 B          | 2018-01-01 |      235 |         313 |        363 |       417 |       1328
 B          | 2018-02-01 |      223 |         135 |        163 |       256 |        777
 B          | 2018-03-01 |      447 |         308 |        186 |       280 |       1221
 B          | 2018-04-01 |      182 |         177 |        108 |       146 |        613
 B          | 2018-05-01 |      164 |         303 |        323 |       455 |       1245
 B          | 2018-06-01 |      295 |         209 |        415 |       249 |       1168
 B          | 2018-07-01 |      363 |         234 |        165 |       320 |       1082
 B          | 2018-08-01 |      348 |         145 |        117 |       308 |        918
 B          | 2018-09-01 |      312 |         283 |        443 |       373 |       1411
 B          | 2018-10-01 |      305 |         365 |        295 |       418 |       1383
 B          | 2018-11-01 |      297 |         411 |        411 |       394 |       1513
 B          | 2018-12-01 |      352 |         177 |        454 |       363 |       1346
 B          | 2019-01-01 |      172 |         365 |        337 |       271 |       1145
 B          | 2019-02-01 |      391 |         138 |        172 |       378 |       1079
 B          | 2019-03-01 |      247 |         410 |        285 |       133 |       1075
 B          | 2019-04-01 |      456 |         414 |        182 |       313 |       1365
 B          | 2019-05-01 |      112 |         266 |        394 |       193 |        965
 B          | 2019-06-01 |      286 |         200 |        234 |       197 |        917
 B          | 2019-07-01 |      457 |         116 |        393 |       302 |       1268
 B          | 2019-08-01 |      224 |         331 |        259 |       135 |        949
 B          | 2019-09-01 |      284 |         398 |        170 |       313 |       1165
 B          | 2019-10-01 |      199 |         230 |        170 |       112 |        711
 B          | 2019-11-01 |      322 |         246 |        135 |       439 |       1142
 B          | 2019-12-01 |      409 |         170 |        317 |       387 |       1283
(48 rows)
```

解答をみると WideToLong 変換を行って、色が増えてもデータ処理フローで自動で取り込まれるような柔軟処理フローになっている。これを SQL で再現しようと思うと、Union することになる。

ただ、色が増えた場合、自動で処理に反映されるような作りにはならない。入力形式が変わっているのに、何も通知もせずに処理が行われる処理フローはいかがなものかとも思う。

```sql
with tmp as (
select
    dealership,
    (when_sold_year::text || '-' || when_sold_month::text || '-01')::date as dt,
    red_cars,
    silver_cars,
    black_cars,
    blue_cars
from
    p2019w01t1
), tmp2 as (
select dealership, dt, red_cars as cars from tmp
union all
select dealership, dt, silver_cars as cars from tmp
union all
select dealership, dt, black_cars as cars from tmp
union all
select dealership, dt, blue_cars as cars from tmp
), tmp3 as (
select
    dealership,
    dt,
    sum(cars) as total_cars
from
    tmp2
group by
    dealership,
    dt
)
select
    t1.dealership,
    t1.dt,
    t1.red_cars,
    t1.silver_cars,
    t1.black_cars,
    t1.blue_cars,
    t2.total_cars
from
    tmp as t1
left join
    tmp3 as t2
on
    t1.dealership = t2.dealership and
    t1.dt = t2.dt
order by
    t1.dealership asc,
    t1.dt asc
;

 dealership |     dt     | red_cars | silver_cars | black_cars | blue_cars | total_cars
------------+------------+----------+-------------+------------+-----------+------------
 A          | 2018-01-01 |      451 |         325 |        377 |       396 |       1549
 A          | 2018-02-01 |      355 |         238 |        259 |       246 |       1098
 A          | 2018-03-01 |      124 |         456 |        303 |       175 |       1058
 A          | 2018-04-01 |      391 |         456 |        429 |       223 |       1499
 A          | 2018-05-01 |      139 |         177 |        241 |       376 |        933
 A          | 2018-06-01 |      345 |         311 |        413 |       126 |       1195
 A          | 2018-07-01 |      257 |         428 |        118 |       184 |        987
 A          | 2018-08-01 |      122 |         392 |        280 |       269 |       1063
 A          | 2018-09-01 |      217 |         124 |        149 |       252 |        742
 A          | 2018-10-01 |      164 |         147 |        252 |       113 |        676
 A          | 2018-11-01 |      220 |         354 |        266 |       168 |       1008
 A          | 2018-12-01 |      366 |         305 |        397 |       135 |       1203
 A          | 2019-01-01 |      367 |         180 |        255 |       107 |        909
 A          | 2019-02-01 |      400 |         382 |        269 |       309 |       1360
 A          | 2019-03-01 |      305 |         247 |        202 |       222 |        976
 A          | 2019-04-01 |      132 |         239 |        415 |       452 |       1238
 A          | 2019-05-01 |      145 |         237 |        361 |       310 |       1053
 A          | 2019-06-01 |      146 |         303 |        240 |       353 |       1042
 A          | 2019-07-01 |      346 |         315 |        205 |       242 |       1108
 A          | 2019-08-01 |      348 |         234 |        421 |       189 |       1192
 A          | 2019-09-01 |      112 |         118 |        414 |       385 |       1029
 A          | 2019-10-01 |      139 |         266 |        435 |       219 |       1059
 A          | 2019-11-01 |      325 |         124 |        460 |       297 |       1206
 A          | 2019-12-01 |      247 |         336 |        130 |       265 |        978
 B          | 2018-01-01 |      235 |         313 |        363 |       417 |       1328
 B          | 2018-02-01 |      223 |         135 |        163 |       256 |        777
 B          | 2018-03-01 |      447 |         308 |        186 |       280 |       1221
 B          | 2018-04-01 |      182 |         177 |        108 |       146 |        613
 B          | 2018-05-01 |      164 |         303 |        323 |       455 |       1245
 B          | 2018-06-01 |      295 |         209 |        415 |       249 |       1168
 B          | 2018-07-01 |      363 |         234 |        165 |       320 |       1082
 B          | 2018-08-01 |      348 |         145 |        117 |       308 |        918
 B          | 2018-09-01 |      312 |         283 |        443 |       373 |       1411
 B          | 2018-10-01 |      305 |         365 |        295 |       418 |       1383
 B          | 2018-11-01 |      297 |         411 |        411 |       394 |       1513
 B          | 2018-12-01 |      352 |         177 |        454 |       363 |       1346
 B          | 2019-01-01 |      172 |         365 |        337 |       271 |       1145
 B          | 2019-02-01 |      391 |         138 |        172 |       378 |       1079
 B          | 2019-03-01 |      247 |         410 |        285 |       133 |       1075
 B          | 2019-04-01 |      456 |         414 |        182 |       313 |       1365
 B          | 2019-05-01 |      112 |         266 |        394 |       193 |        965
 B          | 2019-06-01 |      286 |         200 |        234 |       197 |        917
 B          | 2019-07-01 |      457 |         116 |        393 |       302 |       1268
 B          | 2019-08-01 |      224 |         331 |        259 |       135 |        949
 B          | 2019-09-01 |      284 |         398 |        170 |       313 |       1165
 B          | 2019-10-01 |      199 |         230 |        170 |       112 |        711
 B          | 2019-11-01 |      322 |         246 |        135 |       439 |       1142
 B          | 2019-12-01 |      409 |         170 |        317 |       387 |       1283
(48 rows)
```

## :closed_book: Reference

None
