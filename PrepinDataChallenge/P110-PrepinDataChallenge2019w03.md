## :memo: Overview

Preppin' Data challenge の「2019: Week 3」の問題を SQL で解答する。問題文と解答は下記の公式サイトより確認下さい。

- [Question](https://preppindata.blogspot.com/2019/02/2019-week-3.html)
- [Answer](https://preppindata.blogspot.com/2019/03/2019-week-3-solution.html)

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`Preppin'Data challenge`

## :pencil2: Example

提供されたデータこちら。契約データがあって、ここから契約期間を可視化する、というお題。

```sql
select * from p2019w03t1;
 payment_date |   name   | monthly_cost | contract_length_months_ | start_date
--------------+----------+--------------+-------------------------+------------
 12/13/2018   | Carl     |           20 |                      24 | 12/13/2018
 12/13/2019   | Jonathan |           15 |                       6 | 02/22/2019
 12/13/2020   | Andy     |           45 |                      12 | 10/17/2018
 12/13/2021   | Sophie   |           30 |                      12 | 11/19/2018
(4 rows)

select * from p2019w03t2;
 length
--------
      1
      2
      3
[略]
     22
     23
     24
(24 rows)
```

`generate_series`関数でも良いがデータが提供されているので、こちらを利用して、レコードを意図的に`contract_length_months_`にあわせて重複させていく。

```sql
select
    to_date(t1.payment_date, 'MM/DD/YYYY') as payment_date_mod,
    t1.name,
    t1.monthly_cost,
    t1.contract_length_months_,
    to_date(t1.start_date, 'MM/DD/YYYY') as start_date_mod,
    t2.length,
    (to_date(t1.start_date, 'MM/DD/YYYY') + cast(t2.length::text || 'months' as interval))::date as dt
from
    p2019w03t1 as t1
left join
    p2019w03t2 as t2
on
    t1.contract_length_months_ >= t2.length
;
 payment_date_mod |   name   | monthly_cost | contract_length_months_ | start_date_mod | length |   dt
------------------+----------+--------------+-------------------------+----------------+--------+---------
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |      1 | 2019-01
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |      2 | 2019-02
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |      3 | 2019-03
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |      4 | 2019-04
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |      5 | 2019-05
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |      6 | 2019-06
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |      7 | 2019-07
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |      8 | 2019-08
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |      9 | 2019-09
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     10 | 2019-10
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     11 | 2019-11
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     12 | 2019-12
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     13 | 2020-01
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     14 | 2020-02
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     15 | 2020-03
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     16 | 2020-04
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     17 | 2020-05
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     18 | 2020-06
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     19 | 2020-07
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     20 | 2020-08
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     21 | 2020-09
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     22 | 2020-10
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     23 | 2020-11
 2018-12-13       | Carl     |           20 |                      24 | 2018-12-13     |     24 | 2020-12
 2019-12-13       | Jonathan |           15 |                       6 | 2019-02-22     |      1 | 2019-03
 2019-12-13       | Jonathan |           15 |                       6 | 2019-02-22     |      2 | 2019-04
 2019-12-13       | Jonathan |           15 |                       6 | 2019-02-22     |      3 | 2019-05
 2019-12-13       | Jonathan |           15 |                       6 | 2019-02-22     |      4 | 2019-06
 2019-12-13       | Jonathan |           15 |                       6 | 2019-02-22     |      5 | 2019-07
 2019-12-13       | Jonathan |           15 |                       6 | 2019-02-22     |      6 | 2019-08
[略]
(54 rows)
```

あとは重複させた特に使った数字を使って日付を作る。最後に集計すれば終了。ヒストグラムはおまけ。

```sql
with tmp as (
select
    t1.monthly_cost,
    t2.length,
    substr((to_date(t1.start_date, 'MM/DD/YYYY') + cast(t2.length::text || 'months' as interval))::text, 1, 7) as dt
from
    p2019w03t1 as t1
left join
    p2019w03t2 as t2
on
    t1.contract_length_months_ >= t2.length
)
select
    dt,
    sum(monthly_cost) as sum_monthly_cost,
    lpad('*', floor(sum(monthly_cost)/5)::integer, '*') as hist
from
    tmp
group by
    dt
order by
    dt asc
;

   dt    | sum_monthly_cost |          hist
---------+------------------+------------------------
 2018-11 |               45 | *********
 2018-12 |               75 | ***************
 2019-01 |               95 | *******************
 2019-02 |               95 | *******************
 2019-03 |              110 | **********************
 2019-04 |              110 | **********************
 2019-05 |              110 | **********************
 2019-06 |              110 | **********************
 2019-07 |              110 | **********************
 2019-08 |              110 | **********************
 2019-09 |               95 | *******************
 2019-10 |               95 | *******************
 2019-11 |               50 | **********
 2019-12 |               20 | ****
 2020-01 |               20 | ****
 2020-02 |               20 | ****
 2020-03 |               20 | ****
 2020-04 |               20 | ****
 2020-05 |               20 | ****
 2020-06 |               20 | ****
 2020-07 |               20 | ****
 2020-08 |               20 | ****
 2020-09 |               20 | ****
 2020-10 |               20 | ****
 2020-11 |               20 | ****
 2020-12 |               20 | ****
(26 rows)
```

## :closed_book: Reference

None
