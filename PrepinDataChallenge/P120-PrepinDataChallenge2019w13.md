## :memo: Overview

Preppin' Data challenge の「2019: Week 13」の問題を SQL で解答する。問題文と解答は下記の公式サイトより確認下さい。

- [Question](https://preppindata.blogspot.com/2019/05/2019-week-13.html)
- [Answer](https://preppindata.blogspot.com/2019/05/2019-week-13-solution.html)

## :floppy_disk: Database

PostgreSQL

## :bookmark: Tag

`Preppin'Data challenge`

## :pencil2: Example

提供されたデータこちら。銀行の顧客残高のテーブルデータで下記を分析するというお題。

- 週、月、四半期の平均収支は?
- 週、月、四半期の平均取引額は?
- 顧客の残高がマイナスになるのは何日ですか?
- 顧客が与信限度額を超えた日数は?

```sql
select * from p2019w13t1 limit 10;
 account |    date    | transaction | balance |
---------+------------+-------------+---------+
 1237421 | 2019/01/01 |         578 |  100000 |
 1237421 | 2019/01/02 |         198 |   99422 |
 1237421 | 2019/01/03 |        1806 |   99224 |
 1237421 | 2019/01/04 |         144 |   97418 |
 1237421 | 2019/01/05 |        2240 |   97274 |
 1237421 | 2019/01/06 |        1773 |   95034 |
 1237421 | 2019/01/07 |        2431 |   93261 |
 1237421 | 2019/01/08 |        1900 |   90830 |
 1237421 | 2019/01/09 |         490 |   88930 |
 1237421 | 2019/01/10 |         631 |   88440 |
(10 rows)

select * from p2019w13t2 limit 10;
 account  |        name         | max_credit |
----------+---------------------+------------+
  1237421 | Bubbly McBubbleface |      10000 |
  4271819 | Bubblicious         |      30000 |
 12371202 | Bubbleburst         |       5000 |
```

まずはお題に答えるために必要はカレンダー要素を計算する。そして、フラグはバランスが 0 以下かどうか、最大信用学を超過しているかどうかを計算する。

```sql
select
    t1.account,
    t2.name,
    t1.date,
    date_part('week', t1.date::date) as week_date,
    date_part('month', t1.date::date) as month_date,
    date_part('quarter', t1.date::date) as quarter_date,
    t1.transaction,
    t1.balance,
    t2.max_credit,
    case when t1.balance >= 0 then 0 else 1 end as blance_below_zero,
    case when t1.balance >= -1*t2.max_credit then 0 else 1 end as max_credit_exceeded
from
    p2019w13t1 as t1
left join
    p2019w13t2 as t2
on
    t1.account = t2.account
;

 account |        name         |    date    | week_date | month_date | quarter_date | transaction | balance | max_credit | blance_below_zero | max_credit_exceeded
---------+---------------------+------------+-----------+------------+--------------+-------------+---------+------------+-------------------+---------------------
 1237421 | Bubbly McBubbleface | 2019/06/30 |        26 |          6 |            2 |        2346 |   12891 |      10000 |                 0 |                   0
 1237421 | Bubbly McBubbleface | 2019/06/29 |        26 |          6 |            2 |         203 |   13094 |      10000 |                 0 |                   0
 1237421 | Bubbly McBubbleface | 2019/06/28 |        26 |          6 |            2 |        1580 |   14674 |      10000 |                 0 |                   0
 1237421 | Bubbly McBubbleface | 2019/06/27 |        26 |          6 |            2 |        1899 |   16573 |      10000 |                 0 |                   0
 1237421 | Bubbly McBubbleface | 2019/06/26 |        26 |          6 |            2 |        1808 |   18381 |      10000 |                 0 |                   0
 1237421 | Bubbly McBubbleface | 2019/06/25 |        26 |          6 |            2 |         817 |   19198 |      10000 |                 0 |                   0
 1237421 | Bubbly McBubbleface | 2019/06/24 |        26 |          6 |            2 |        2146 |   21344 |      10000 |                 0 |                   0
 1237421 | Bubbly McBubbleface | 2019/06/23 |        25 |          6 |            2 |        1553 |   22897 |      10000 |                 0 |                   0
 1237421 | Bubbly McBubbleface | 2019/06/22 |        25 |          6 |            2 |         152 |   23049 |      10000 |                 0 |                   0
 1237421 | Bubbly McBubbleface | 2019/06/21 |        25 |          6 |            2 |         201 |   23250 |      10000 |                 0 |                   0
(10 rows)
```

あとは週、月、クオーターごとに計算すれば OK。これは、週毎の集計結果。

```sql
with tmp as (
select
    t1.account,
    t2.name,
    t1.date,
    date_part('week', t1.date::date) as week_date,
    date_part('month', t1.date::date) as month_date,
    date_part('quarter', t1.date::date) as quarter_date,
    t1.transaction,
    t1.balance,
    t2.max_credit,
    case when t1.balance >= 0 then 0 else 1 end as blance_below_zero,
    case when t1.balance >= -1*t2.max_credit then 0 else 1 end as max_credit_exceeded
from
    p2019w13t1 as t1
left join
    p2019w13t2 as t2
on
    t1.account = t2.account
)
select
    account, name, week_date,
    min(date) as min_date,
    avg(transaction) as weekly_avg_transaction,
    sum(blance_below_zero) as sum_blance_below_zero,
    sum(max_credit_exceeded) as sum_credit_exceeded,
    avg(balance) as weekly_avg_balances
from
    tmp
group by
    account,
    name,
    week_date
order by
    account,
    week_date asc
;

 account  |        name         | week_date |  min_date  | weekly_avg_transaction | sum_blance_below_zero | sum_credit_exceeded |  weekly_avg_balances
----------+---------------------+-----------+------------+------------------------+-----------------------+---------------------+------------------------
  1237421 | Bubbly McBubbleface |         1 | 2019/01/01 |  1123.1666666666666667 |                     0 |                   0 |     98062.000000000000
  1237421 | Bubbly McBubbleface |         2 | 2019/01/07 |  1210.8571428571428571 |                     0 |                   0 |     88868.714285714286
  1237421 | Bubbly McBubbleface |         3 | 2019/01/14 |  1346.7142857142857143 |                     0 |                   0 |     80731.571428571429
  1237421 | Bubbly McBubbleface |         4 | 2019/01/21 |  1200.2857142857142857 |                     0 |                   0 |     72790.714285714286
  1237421 | Bubbly McBubbleface |         5 | 2019/01/28 |  1305.4285714285714286 |                     0 |                   0 |     69113.857142857143
  1237421 | Bubbly McBubbleface |         6 | 2019/02/04 |   844.7142857142857143 |                     0 |                   0 |     68384.142857142857
  1237421 | Bubbly McBubbleface |         7 | 2019/02/11 |  1703.4285714285714286 |                     0 |                   0 |     58427.714285714286
  1237421 | Bubbly McBubbleface |         8 | 2019/02/18 |  1310.7142857142857143 |                     0 |                   0 |     49104.285714285714
  1237421 | Bubbly McBubbleface |         9 | 2019/02/25 |   906.5714285714285714 |                     0 |                   0 |     49253.714285714286
  1237421 | Bubbly McBubbleface |        10 | 2019/03/04 |  1526.2857142857142857 |                     0 |                   0 |     51799.000000000000
  1237421 | Bubbly McBubbleface |        11 | 2019/03/11 |   852.1428571428571429 |                     0 |                   0 |     42799.142857142857
  1237421 | Bubbly McBubbleface |        12 | 2019/03/18 |  1072.1428571428571429 |                     0 |                   0 |     36462.428571428571
  1237421 | Bubbly McBubbleface |        13 | 2019/03/25 |  1342.5714285714285714 |                     0 |                   0 |     27295.285714285714
  1237421 | Bubbly McBubbleface |        14 | 2019/04/01 |  1365.0000000000000000 |                     0 |                   0 |     39215.285714285714
  1237421 | Bubbly McBubbleface |        15 | 2019/04/08 |  1915.4285714285714286 |                     0 |                   0 |     27548.857142857143
  1237421 | Bubbly McBubbleface |        16 | 2019/04/15 |  1315.7142857142857143 |                     0 |                   0 |     16136.714285714286
  1237421 | Bubbly McBubbleface |        17 | 2019/04/22 |  1105.5714285714285714 |                     0 |                   0 |  6371.5714285714285714
  1237421 | Bubbly McBubbleface |        18 | 2019/04/29 |  1022.7142857142857143 |                     0 |                   0 |     17634.428571428571
  1237421 | Bubbly McBubbleface |        19 | 2019/05/06 |  1524.1428571428571429 |                     0 |                   0 |     17666.000000000000
  1237421 | Bubbly McBubbleface |        20 | 2019/05/13 |  1345.7142857142857143 |                     0 |                   0 |  7663.7142857142857143
  1237421 | Bubbly McBubbleface |        21 | 2019/05/20 |  1586.1428571428571429 |                     5 |                   0 | -2288.7142857142857143
  1237421 | Bubbly McBubbleface |        22 | 2019/05/27 |  1412.7142857142857143 |                     5 |                   4 |  5738.2857142857142857
  1237421 | Bubbly McBubbleface |        23 | 2019/06/03 |  1369.0000000000000000 |                     0 |                   0 |     41049.571428571429
  1237421 | Bubbly McBubbleface |        24 | 2019/06/10 |  1133.5714285714285714 |                     0 |                   0 |     32409.857142857143
  1237421 | Bubbly McBubbleface |        25 | 2019/06/17 |   955.7142857142857143 |                     0 |                   0 |     24977.571428571429
  1237421 | Bubbly McBubbleface |        26 | 2019/06/24 |  1542.7142857142857143 |                     0 |                   0 |     16593.571428571429
  4271819 | Bubblicious         |         1 | 2019/01/01 |  1141.5000000000000000 |                     0 |                   0 |     96642.500000000000
  4271819 | Bubblicious         |         2 | 2019/01/07 |  1501.0000000000000000 |                     0 |                   0 |     88867.571428571429
  4271819 | Bubblicious         |         3 | 2019/01/14 |  1097.5714285714285714 |                     0 |                   0 |     79392.000000000000
  4271819 | Bubblicious         |         4 | 2019/01/21 |   807.2857142857142857 |                     0 |                   0 |     71984.000000000000
  4271819 | Bubblicious         |         5 | 2019/01/28 |  1248.1428571428571429 |                     0 |                   0 |     70698.142857142857
  4271819 | Bubblicious         |         6 | 2019/02/04 |   834.2857142857142857 |                     0 |                   0 |     68951.285714285714
  4271819 | Bubblicious         |         7 | 2019/02/11 |  1105.4285714285714286 |                     0 |                   0 |     61789.142857142857
  4271819 | Bubblicious         |         8 | 2019/02/18 |   747.5714285714285714 |                     0 |                   0 |     55811.285714285714
  4271819 | Bubblicious         |         9 | 2019/02/25 |  1407.0000000000000000 |                     0 |                   0 |     53728.142857142857
  4271819 | Bubblicious         |        10 | 2019/03/04 |  1091.7142857142857143 |                     0 |                   0 |     52078.428571428571
  4271819 | Bubblicious         |        11 | 2019/03/11 |  1559.8571428571428571 |                     0 |                   0 |     44285.571428571429
  4271819 | Bubblicious         |        12 | 2019/03/18 |  1406.2857142857142857 |                     0 |                   0 |     33316.428571428571
  4271819 | Bubblicious         |        13 | 2019/03/25 |  1078.1428571428571429 |                     0 |                   0 |     24003.857142857143
  4271819 | Bubblicious         |        14 | 2019/04/01 |  1052.4285714285714286 |                     0 |                   0 |     38470.428571428571
  4271819 | Bubblicious         |        15 | 2019/04/08 |  1182.1428571428571429 |                     0 |                   0 |     31739.571428571429
  4271819 | Bubblicious         |        16 | 2019/04/15 |  1062.8571428571428571 |                     0 |                   0 |     22391.142857142857
  4271819 | Bubblicious         |        17 | 2019/04/22 |  1263.5714285714285714 |                     0 |                   0 |     14463.714285714286
  4271819 | Bubblicious         |        18 | 2019/04/29 |   695.1428571428571429 |                     0 |                   0 |     21154.142857142857
  4271819 | Bubblicious         |        19 | 2019/05/06 |  1267.7142857142857143 |                     0 |                   0 |     19829.142857142857
  4271819 | Bubblicious         |        20 | 2019/05/13 |  1094.4285714285714286 |                     0 |                   0 | 11360.8571428571428571
  4271819 | Bubblicious         |        21 | 2019/05/20 |  1201.5714285714285714 |                     2 |                   0 |  2558.8571428571428571
  4271819 | Bubblicious         |        22 | 2019/05/27 |   830.4285714285714286 |                     5 |                   0 |     12087.142857142857
  4271819 | Bubblicious         |        23 | 2019/06/03 |  1578.7142857142857143 |                     0 |                   0 |     43763.000000000000
  4271819 | Bubblicious         |        24 | 2019/06/10 |   760.4285714285714286 |                     0 |                   0 |     34922.142857142857
  4271819 | Bubblicious         |        25 | 2019/06/17 |  1752.8571428571428571 |                     0 |                   0 |     26679.857142857143
  4271819 | Bubblicious         |        26 | 2019/06/24 |  1721.8571428571428571 |                     0 |                   0 |     13506.285714285714
 12371202 | Bubbleburst         |         1 | 2019/01/01 |   277.0000000000000000 |                     0 |                   0 |  4267.5000000000000000
 12371202 | Bubbleburst         |         2 | 2019/01/07 |   153.4285714285714286 |                     0 |                   0 |  2728.2857142857142857
 12371202 | Bubbleburst         |         3 | 2019/01/14 |   301.4285714285714286 |                     0 |                   0 |  1500.0000000000000000
 12371202 | Bubbleburst         |         4 | 2019/01/21 |   352.7142857142857143 |                     6 |                   0 |  -830.4285714285714286
 12371202 | Bubbleburst         |         5 | 2019/01/28 |   193.7142857142857143 |                     4 |                   0 |  5651.2857142857142857
 12371202 | Bubbleburst         |         6 | 2019/02/04 |   261.8571428571428571 |                     0 |                   0 |     15715.000000000000
 12371202 | Bubbleburst         |         7 | 2019/02/11 |   213.0000000000000000 |                     0 |                   0 |     13985.571428571429
 12371202 | Bubbleburst         |         8 | 2019/02/18 |   258.8571428571428571 |                     0 |                   0 |     12132.285714285714
 12371202 | Bubbleburst         |         9 | 2019/02/25 |   253.0000000000000000 |                     0 |                   0 |  8697.8571428571428571
 12371202 | Bubbleburst         |        10 | 2019/03/04 |   214.2857142857142857 |                     0 |                   0 |  4868.0000000000000000
 12371202 | Bubbleburst         |        11 | 2019/03/11 |   207.7142857142857143 |                     0 |                   0 |  3516.1428571428571429
 12371202 | Bubbleburst         |        12 | 2019/03/18 |   166.5714285714285714 |                     0 |                   0 |  2191.8571428571428571
 12371202 | Bubbleburst         |        13 | 2019/03/25 |   369.2857142857142857 |                     3 |                   0 |   287.4285714285714286
 12371202 | Bubbleburst         |        14 | 2019/04/01 |   306.2857142857142857 |                     0 |                   0 |     16308.857142857143
 12371202 | Bubbleburst         |        15 | 2019/04/08 |   265.1428571428571429 |                     0 |                   0 |     14298.857142857143
 12371202 | Bubbleburst         |        16 | 2019/04/15 |   329.0000000000000000 |                     0 |                   0 |     12086.857142857143
 12371202 | Bubbleburst         |        17 | 2019/04/22 |   244.0000000000000000 |                     0 |                   0 |  9925.7142857142857143
 12371202 | Bubbleburst         |        18 | 2019/04/29 |   280.5714285714285714 |                     0 |                   0 |  7985.0000000000000000
 12371202 | Bubbleburst         |        19 | 2019/05/06 |   236.2857142857142857 |                     0 |                   0 |  6277.5714285714285714
 12371202 | Bubbleburst         |        20 | 2019/05/13 |   237.7142857142857143 |                     0 |                   0 |  4570.5714285714285714
 12371202 | Bubbleburst         |        21 | 2019/05/20 |   189.4285714285714286 |                     0 |                   0 |  2993.8571428571428571
 12371202 | Bubbleburst         |        22 | 2019/05/27 |   305.8571428571428571 |                     0 |                   0 |  2607.8571428571428571
 12371202 | Bubbleburst         |        23 | 2019/06/03 |   258.1428571428571429 |                     0 |                   0 |  3350.7142857142857143
 12371202 | Bubbleburst         |        24 | 2019/06/10 |   300.2857142857142857 |                     0 |                   0 |  1730.5714285714285714
 12371202 | Bubbleburst         |        25 | 2019/06/17 |   332.0000000000000000 |                     6 |                   0 |  -753.8571428571428571
 12371202 | Bubbleburst         |        26 | 2019/06/24 |   225.7142857142857143 |                     7 |                   0 | -2685.0000000000000000
(78 rows)
```

## :closed_book: Reference

None
